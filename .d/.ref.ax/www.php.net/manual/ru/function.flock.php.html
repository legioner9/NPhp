<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ru">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>PHP: flock - Manual </title>

 <link rel="icon" type="image/svg+xml" sizes="any" href="../../favicon.svg%3Fv=2">
 <link rel="icon" type="image/png" sizes="196x196" href="../../favicon-196x196.png%3Fv=2">
 <link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png%3Fv=2">
 <link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png%3Fv=2">
 <link rel="shortcut icon" href="../../favicon.ico%3Fv=2">

 <link rel="search" type="application/opensearchdescription+xml" href="http://php.net/phpnetimprovedsearch.src" title="Add PHP.net search">
 <link rel="alternate" type="application/atom+xml" href="https://www.php.net/releases/feed.php" title="PHP Release feed">
 <link rel="alternate" type="application/atom+xml" href="https://www.php.net/feed.atom" title="PHP: Hypertext Preprocessor">

 <link rel="canonical" href="function.flock.php.html">
 <link rel="shorturl" href="https://www.php.net/flock">
 <link rel="alternate" href="https://www.php.net/flock" hreflang="x-default">

 <link rel="contents" href="index.php.html">
 <link rel="index" href="ref.filesystem.php.html">
 <link rel="prev" href="function.filetype.php.html">
 <link rel="next" href="function.fnmatch.php.html">

 <link rel="alternate" href="https://www.php.net/manual/en/function.flock.php" hreflang="en">
 <link rel="alternate" href="https://www.php.net/manual/de/function.flock.php" hreflang="de">
 <link rel="alternate" href="https://www.php.net/manual/es/function.flock.php" hreflang="es">
 <link rel="alternate" href="https://www.php.net/manual/fr/function.flock.php" hreflang="fr">
 <link rel="alternate" href="https://www.php.net/manual/it/function.flock.php" hreflang="it">
 <link rel="alternate" href="https://www.php.net/manual/ja/function.flock.php" hreflang="ja">
 <link rel="alternate" href="https://www.php.net/manual/pt_BR/function.flock.php" hreflang="pt_BR">
 <link rel="alternate" href="function.flock.php.html" hreflang="ru">
 <link rel="alternate" href="https://www.php.net/manual/tr/function.flock.php" hreflang="tr">
 <link rel="alternate" href="https://www.php.net/manual/zh/function.flock.php" hreflang="zh">

<link rel="stylesheet" type="text/css" href="../../cached.php%3Ft=1689765002&amp;f=%252Ffonts%252FFira%252Ffira.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cached.php%3Ft=1700771401&amp;f=%252Ffonts%252FFont-Awesome%252Fcss%252Ffontello.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cached.php%3Ft=1705413607&amp;f=%252Fstyles%252Ftheme-base.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cached.php%3Ft=1701958202&amp;f=%252Fstyles%252Ftheme-medium.css" media="screen">

 <base href="">


</head>
<body class="docs ">

<nav id="head-nav" class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <a href="https://www.php.net/" class="brand"><img src="../../images/logos/php-logo.svg" width="48" height="24" alt="php"></a>
    <div id="mainmenu-toggle-overlay"></div>
    <input type="checkbox" id="mainmenu-toggle">
    <ul class="nav">
      <li class=""><a href="https://www.php.net/downloads">Downloads</a></li>
      <li class="active"><a href="https://www.php.net/docs.php">Documentation</a></li>
      <li class=""><a href="https://www.php.net/get-involved" >Get Involved</a></li>
      <li class=""><a href="https://www.php.net/support">Help</a></li>
      <li class="">
        <a href="https://www.php.net/releases/8.3/index.php">
          <img src="../../images/php8/logo_php8_3.svg" alt="php8.3" height="22" width="60">
        </a>
      </li>
    </ul>
    <form class="navbar-search" id="topsearch" action="https://www.php.net/search.php">
      <input type="hidden" name="show" value="quickref">
      <input type="search" name="pattern" class="search-query" placeholder="Search" accesskey="s">
    </form>
  </div>
  <div id="flash-message"></div>
</nav>
<div class="headsup"><a href='https://www.php.net/conferences/index.php#2024-02-13-1'>Dutch PHP Conference 2024</a></div>
<nav id="trick"><div><dl>
<dt><a href='https://www.php.net/manual/en/getting-started.php'>Getting Started</a></dt>
	<dd><a href='https://www.php.net/manual/en/introduction.php'>Introduction</a></dd>
	<dd><a href='https://www.php.net/manual/en/tutorial.php'>A simple tutorial</a></dd>
<dt><a href='https://www.php.net/manual/en/langref.php'>Language Reference</a></dt>
	<dd><a href='https://www.php.net/manual/en/language.basic-syntax.php'>Basic syntax</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.types.php'>Types</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.variables.php'>Variables</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.constants.php'>Constants</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.expressions.php'>Expressions</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.operators.php'>Operators</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.control-structures.php'>Control Structures</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.functions.php'>Functions</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.oop5.php'>Classes and Objects</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.namespaces.php'>Namespaces</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.enumerations.php'>Enumerations</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.errors.php'>Errors</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.exceptions.php'>Exceptions</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.fibers.php'>Fibers</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.generators.php'>Generators</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.attributes.php'>Attributes</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.references.php'>References Explained</a></dd>
	<dd><a href='https://www.php.net/manual/en/reserved.variables.php'>Predefined Variables</a></dd>
	<dd><a href='https://www.php.net/manual/en/reserved.exceptions.php'>Predefined Exceptions</a></dd>
	<dd><a href='https://www.php.net/manual/en/reserved.interfaces.php'>Predefined Interfaces and Classes</a></dd>
	<dd><a href='https://www.php.net/manual/en/reserved.attributes.php'>Predefined Attributes</a></dd>
	<dd><a href='https://www.php.net/manual/en/context.php'>Context options and parameters</a></dd>
	<dd><a href='https://www.php.net/manual/en/wrappers.php'>Supported Protocols and Wrappers</a></dd>
</dl>
<dl>
<dt><a href='https://www.php.net/manual/en/security.php'>Security</a></dt>
	<dd><a href='https://www.php.net/manual/en/security.intro.php'>Introduction</a></dd>
	<dd><a href='https://www.php.net/manual/en/security.general.php'>General considerations</a></dd>
	<dd><a href='https://www.php.net/manual/en/security.cgi-bin.php'>Installed as CGI binary</a></dd>
	<dd><a href='https://www.php.net/manual/en/security.apache.php'>Installed as an Apache module</a></dd>
	<dd><a href='https://www.php.net/manual/en/security.sessions.php'>Session Security</a></dd>
	<dd><a href='https://www.php.net/manual/en/security.filesystem.php'>Filesystem Security</a></dd>
	<dd><a href='https://www.php.net/manual/en/security.database.php'>Database Security</a></dd>
	<dd><a href='https://www.php.net/manual/en/security.errors.php'>Error Reporting</a></dd>
	<dd><a href='https://www.php.net/manual/en/security.variables.php'>User Submitted Data</a></dd>
	<dd><a href='https://www.php.net/manual/en/security.hiding.php'>Hiding PHP</a></dd>
	<dd><a href='https://www.php.net/manual/en/security.current.php'>Keeping Current</a></dd>
<dt><a href='https://www.php.net/manual/en/features.php'>Features</a></dt>
	<dd><a href='https://www.php.net/manual/en/features.http-auth.php'>HTTP authentication with PHP</a></dd>
	<dd><a href='https://www.php.net/manual/en/features.cookies.php'>Cookies</a></dd>
	<dd><a href='https://www.php.net/manual/en/features.sessions.php'>Sessions</a></dd>
	<dd><a href='https://www.php.net/manual/en/features.xforms.php'>Dealing with XForms</a></dd>
	<dd><a href='https://www.php.net/manual/en/features.file-upload.php'>Handling file uploads</a></dd>
	<dd><a href='https://www.php.net/manual/en/features.remote-files.php'>Using remote files</a></dd>
	<dd><a href='https://www.php.net/manual/en/features.connection-handling.php'>Connection handling</a></dd>
	<dd><a href='https://www.php.net/manual/en/features.persistent-connections.php'>Persistent Database Connections</a></dd>
	<dd><a href='https://www.php.net/manual/en/features.commandline.php'>Command line usage</a></dd>
	<dd><a href='https://www.php.net/manual/en/features.gc.php'>Garbage Collection</a></dd>
	<dd><a href='https://www.php.net/manual/en/features.dtrace.php'>DTrace Dynamic Tracing</a></dd>
</dl>
<dl>
<dt><a href='https://www.php.net/manual/en/funcref.php'>Function Reference</a></dt>
	<dd><a href='https://www.php.net/manual/en/refs.basic.php.php'>Affecting PHP's Behaviour</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.utilspec.audio.php'>Audio Formats Manipulation</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.remote.auth.php'>Authentication Services</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.utilspec.cmdline.php'>Command Line Specific Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.compression.php'>Compression and Archive Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.crypto.php'>Cryptography Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.database.php'>Database Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.calendar.php'>Date and Time Related Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.fileprocess.file.php'>File System Related Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.international.php'>Human Language and Character Encoding Support</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.utilspec.image.php'>Image Processing and Generation</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.remote.mail.php'>Mail Related Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.math.php'>Mathematical Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.utilspec.nontext.php'>Non-Text MIME Output</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.fileprocess.process.php'>Process Control Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.basic.other.php'>Other Basic Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.remote.other.php'>Other Services</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.search.php'>Search Engine Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.utilspec.server.php'>Server Specific Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.basic.session.php'>Session Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.basic.text.php'>Text Processing</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.basic.vartype.php'>Variable and Type Related Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.webservice.php'>Web Services</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.utilspec.windows.php'>Windows Only Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.xml.php'>XML Manipulation</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.ui.php'>GUI Extensions</a></dd>
</dl>
<dl>
<dt>Keyboard Shortcuts</dt><dt>?</dt>
<dd>This help</dd>
<dt>j</dt>
<dd>Next menu item</dd>
<dt>k</dt>
<dd>Previous menu item</dd>
<dt>g p</dt>
<dd>Previous man page</dd>
<dt>g n</dt>
<dd>Next man page</dd>
<dt>G</dt>
<dd>Scroll to bottom</dd>
<dt>g g</dt>
<dd>Scroll to top</dd>
<dt>g h</dt>
<dd>Goto homepage</dd>
<dt>g s</dt>
<dd>Goto search<br>(current page)</dd>
<dt>/</dt>
<dd>Focus search box</dd>
</dl></div></nav>
<div id="goto">
    <div class="search">
         <div class="text"></div>
         <div class="results"><ul></ul></div>
   </div>
</div>

  <div id="breadcrumbs" class="clearfix">
    <div id="breadcrumbs-inner">
          <div class="next">
        <a href="function.fnmatch.php.html">
          fnmatch &raquo;
        </a>
      </div>
              <div class="prev">
        <a href="function.filetype.php.html">
          &laquo; filetype        </a>
      </div>
          <ul>
            <li><a href='index.php.html'>Руководство по PHP</a></li>      <li><a href='funcref.php.html'>Справочник функций</a></li>      <li><a href='refs.fileprocess.file.php.html'>Модули для работы с файловой системой</a></li>      <li><a href='book.filesystem.php.html'>Файловая система</a></li>      <li><a href='ref.filesystem.php.html'>Функции файловой системы</a></li>      </ul>
    </div>
  </div>




<div id="layout" class="clearfix">
  <section id="layout-content">
  <div class="page-tools">
    <div class="change-language">
      <form action="https://www.php.net/manual/change.php" method="get" id="changelang" name="changelang">
        <fieldset>
          <label for="changelang-langs">Change language:</label>
          <select onchange="document.changelang.submit()" name="page" id="changelang-langs">
            <option value='en/function.flock.php'>English</option>
            <option value='de/function.flock.php'>German</option>
            <option value='es/function.flock.php'>Spanish</option>
            <option value='fr/function.flock.php'>French</option>
            <option value='it/function.flock.php'>Italian</option>
            <option value='ja/function.flock.php'>Japanese</option>
            <option value='pt_BR/function.flock.php'>Brazilian Portuguese</option>
            <option value='ru/function.flock.php' selected="selected">Russian</option>
            <option value='tr/function.flock.php'>Turkish</option>
            <option value='zh/function.flock.php'>Chinese (Simplified)</option>
            <option value='help-translate.php'>Other</option>
          </select>
        </fieldset>
      </form>
    </div>
    <div class="edit-bug">
      <a href="https://github.com/php/doc-ru/blob/master/reference/filesystem/functions/flock.xml">Submit a Pull Request</a>
      <a href="https://github.com/php/doc-ru/issues/new?body=From%20manual%20page:%20https:%2F%2Fphp.net%2Ffunction.flock%0A%0A---">Report a Bug</a>
    </div>
  </div><div id="function.flock" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">flock</h1>
  <p class="verinfo">(PHP 4, PHP 5, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">flock</span> &mdash; <span class="dc-title">Блокирует файл методом переносимой рекомендательной блокировки</span></p>

 </div>

 <div class="refsect1 description" id="refsect1-function.flock-description">
  <h3 class="title">Описание</h3>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>flock</strong></span>(<span class="methodparam"><span class="type">resource</span> <code class="parameter">$stream</code></span>, <span class="methodparam"><span class="type">int</span> <code class="parameter">$operation</code></span>, <span class="methodparam"><span class="type">int</span> <code class="parameter reference">&$would_block</code><span class="initializer"> = <strong><code>null</code></strong></span></span>): <span class="type">bool</span></div>

  <p class="para rdfs-comment">
   Функция <span class="function"><strong>flock()</strong></span> разрешает выполнять простую модель
   чтения-записи, которая будет работать на большей части Unix-платформ
   и даже на платформах семейства Windows.
  </p>
  <p class="para">
   Блокировку также снимает функция <span class="function"><a href="function.fclose.php.html" class="function">fclose()</a></span>
   или сборщик мусора, когда уничтожает поток <code class="parameter">stream</code>.
  </p>
  <p class="para">
   PHP поддерживает способ полной переносимой рекомендательной блокировки
   файлов. То есть каждая программа, которая получает доступ к файлу,
   должна использовать один и тот же способ блокировки, иначе блокировка не будет
   работать. По умолчанию функция будет блокироваться до тех пор,
   пока запрошенная блокировка не будет получена; это поведение изменяют
   через описанный ниже флаг <strong><code>LOCK_NB</code></strong>.
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.flock-parameters">
  <h3 class="title">Список параметров</h3>
  <p class="para">
   <dl>
    
     <dt>
<code class="parameter">stream</code></dt>

     <dd>

      <p class="para">Ресурс (<span class="type">resource</span>)
указателя файловой системы, который часто создают функцией <span class="function"><a href="function.fopen.php.html" class="function">fopen()</a></span>.</p>
     </dd>

    
    
     <dt>
<code class="parameter">operation</code></dt>

     <dd>

      <p class="para">
       <code class="parameter">operation</code> принимает следующие значения:
       <ul class="itemizedlist">
        <li class="listitem">
         <span class="simpara">
          <strong><code>LOCK_SH</code></strong> для получения разделяемой блокировки (чтение).
         </span>
        </li>
        <li class="listitem">
         <span class="simpara">
          <strong><code>LOCK_EX</code></strong> для получения эксклюзивной блокировки (запись).
         </span>
        </li>
        <li class="listitem">
         <span class="simpara">
          <strong><code>LOCK_UN</code></strong> для снятия блокировки (разделяемой или эксклюзивной).
         </span>
        </li>
       </ul>
      </p>
      <p class="para">
       Флаг <strong><code>LOCK_NB</code></strong> добавляют
       как битовую маску к одной операции из списка выше,
       если функция <span class="function"><strong>flock()</strong></span> не должна
       блокироваться во время попытки блокировки файла.
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">would_block</code></dt>

     <dd>

      <p class="para">
       Необязательный третий параметр получает значение 1,
       если блокировка будет блокирующей
       (в переменную errno будет записан код ошибки EWOULDBLOCK).
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.flock-returnvalues">
  <h3 class="title">Возвращаемые значения</h3>
  <p class="para">
   Возвращает <strong><code>true</code></strong> в случае успешного выполнения или <strong><code>false</code></strong> в случае возникновения ошибки.
  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.flock-examples">
  <h3 class="title">Примеры</h3>
  <p class="para">
   <div class="example" id="">
    <p><strong>Пример #1 Пример использования функции <span class="function"><strong>flock()</strong></span></strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /><br />$fp </span><span style="color: #007700">= </span><span style="color: #0000BB">fopen</span><span style="color: #007700">(</span><span style="color: #DD0000">"/tmp/lock.txt"</span><span style="color: #007700">, </span><span style="color: #DD0000">"r+"</span><span style="color: #007700">);<br /><br />if (</span><span style="color: #0000BB">flock</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">, </span><span style="color: #0000BB">LOCK_EX</span><span style="color: #007700">)) { </span><span style="color: #FF8000">// Выполняем эксклюзивную блокировку<br />    </span><span style="color: #0000BB">ftruncate</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">, </span><span style="color: #0000BB">0</span><span style="color: #007700">); </span><span style="color: #FF8000">// Очищаем файл<br />    </span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">, </span><span style="color: #DD0000">"Пишем что-нибудь сюда\n"</span><span style="color: #007700">);<br />    </span><span style="color: #0000BB">fflush</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);        </span><span style="color: #FF8000">// Очищаем вывод перед отменой блокировки<br />    </span><span style="color: #0000BB">flock</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">, </span><span style="color: #0000BB">LOCK_UN</span><span style="color: #007700">); </span><span style="color: #FF8000">// Снимаем блокировку<br /></span><span style="color: #007700">} else {<br />    echo </span><span style="color: #DD0000">"Не удалось получить блокировку!"</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
    </div>

   </div>
  </p>
  <p class="para">
   <div class="example" id="">
    <p><strong>Пример #2 Использование функции <span class="function"><strong>flock()</strong></span> с параметром <strong><code>LOCK_NB</code></strong></strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /><br />$fp </span><span style="color: #007700">= </span><span style="color: #0000BB">fopen</span><span style="color: #007700">(</span><span style="color: #DD0000">'/tmp/lock.txt'</span><span style="color: #007700">, </span><span style="color: #DD0000">'r+'</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/* Включаем опцию LOCK_NB в операцию LOCK_EX */<br /></span><span style="color: #007700">if (!</span><span style="color: #0000BB">flock</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">, </span><span style="color: #0000BB">LOCK_EX </span><span style="color: #007700">| </span><span style="color: #0000BB">LOCK_NB</span><span style="color: #007700">)) {<br />    echo </span><span style="color: #DD0000">'Не удалось получить блокировку'</span><span style="color: #007700">;<br />    exit(-</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #FF8000">/* ... */<br /><br /></span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
    </div>

   </div>
  </p>
 </div>


 <div class="refsect1 notes" id="refsect1-function.flock-notes">
  <h3 class="title">Примечания</h3>
  <blockquote class="note"><p><strong class="note">Замечание</strong>: 
   <p class="para">
    В системах Windows функция <span class="function"><strong>flock()</strong></span> включает обязательную
    блокировку вместо рекомендательной. Обязательная
    блокировка также поддерживается в операционных системах на базе Linux и System V
    через стандартный механизм, который
    поддерживает системный вызов fcntl(): то есть, если для файла
    установлен бит разрешения setgid и сброшен бит группового выполнения.
    Чтобы схема работала корректно в Linux, файловую систему
    также нужно смонтировать с опцией mand.
   </p>
  </p></blockquote>
  <blockquote class="note"><p><strong class="note">Замечание</strong>: 
   <p class="para">
    Поскольку функция <span class="function"><strong>flock()</strong></span> требует указатель
    на файл, возможно, придётся использовать специальный файл
    блокировки, чтобы защитить доступ к файлу, который вы собираетесь обрезать,
    открыв в режиме записи (в режимах «w» или «w+»
    в качестве аргумента функции <span class="function"><a href="function.fopen.php.html" class="function">fopen()</a></span>).
   </p>
  </p></blockquote>
  <blockquote class="note"><p><strong class="note">Замечание</strong>: 
   <p class="para">
    Функцию разрешено вызывать только на дескрипторах локальных файлов,
    которые возвращает функция <span class="function"><a href="function.fopen.php.html" class="function">fopen()</a></span>, или файловых
    дескрипторах пользовательских потоков, которые реализуют метод
    <span class="function"><a href="streamwrapper.stream-lock.php.html" class="function">streamWrapper::stream_lock()</a></span>.
   </p>
  </p></blockquote>
  <div class="warning"><strong class="warning">Внимание</strong>
   <p class="para">
    Присвоение другого значения параметру <code class="parameter">stream</code>
    в следующем дальше коде снимет текущую блокировку.
   </p>
  </div>
  <div class="warning"><strong class="warning">Внимание</strong>
   <p class="para">
    В ряде операционных систем функция <span class="function"><strong>flock()</strong></span> работает
    на уровне процессов. При работе с многопоточными серверными API,
    например, ISAPI, нельзя полагаться на функцию <span class="function"><strong>flock()</strong></span>,
    чтобы защитить файлы от других PHP-скриптов, которые
    работают в параллельном потоке на том же сервере!
   </p>
   <p class="para">
    Функцию <span class="function"><strong>flock()</strong></span> не поддерживают старые файловые системы
    наподобие <code class="literal">FAT</code> и её производные, поэтому функцию будет
    возвращать <strong><code>false</code></strong> в этих окружениях.
   </p>
  </div>
  <blockquote class="note"><p><strong class="note">Замечание</strong>: 
   <p class="para">
    Если в Windows процесс блокировки открывает файл во второй раз, он не может
    получить доступ к файлу через второй дескриптор, пока не разблокирует файл.
   </p>
  </p></blockquote>
 </div>


</div><section id="usernotes">
 <div class="head">
  <span class="action"><a href="https://www.php.net/manual/add-note.php?sect=function.flock&amp;redirect=https://www.php.net/manual/ru/function.flock.php">＋<small>add a note</small></a></span>
  <h3 class="title">User Contributed Notes <span class="count">40 notes</span></h3>
 </div><div id="allnotes">
  <div class="note" id="78318">  <div class="votes">
    <div id="Vu78318">
    <a href="https://www.php.net/manual/vote-note.php?id=78318&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd78318">
    <a href="https://www.php.net/manual/vote-note.php?id=78318&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V78318" title="87% like this...">
    165
    </div>
  </div>
  <a href="function.flock.php.html#78318" class="name">
  <strong class="user"><em>Antti Haapala</em></strong></a><a class="genanchor" href="function.flock.php.html#78318"> &para;</a><div class="date" title="2007-10-06 03:41"><strong>16 years ago</strong></div>
  <div class="text" id="Hcom78318">
<div class="phpcode"><code><span class="html">The supplied documentation is vague, ambiguous and lacking, and the user comments contain erroneous information! The flock function follows the semantics of the Unix system call bearing the same name. Flock utilizes ADVISORY locking only; that is, other processes may ignore the lock completely; it only affects those that call the flock call.<br /><br />LOCK_SH means SHARED LOCK. Any number of processes MAY HAVE A SHARED LOCK simultaneously. It is commonly called a reader lock.<br /><br />LOCK_EX means EXCLUSIVE LOCK. Only a single process may possess an exclusive lock to a given file at a time.<br /><br />If the file has been LOCKED with LOCK_SH in another process, flock with LOCK_SH will SUCCEED. flock with LOCK_EX will BLOCK UNTIL ALL READER LOCKS HAVE BEEN RELEASED.<br /><br />If the file has been locked with LOCK_EX in another process, the CALL WILL BLOCK UNTIL ALL OTHER LOCKS have been released.<br /><br />If however, you call flock on a file on which you possess the lock, it will try to change it. So: flock(LOCK_EX) followed by flock(LOCK_SH) will get you a SHARED lock, not "read-write" lock.</span></code></div>
  </div>
 </div>
  <div class="note" id="78320">  <div class="votes">
    <div id="Vu78320">
    <a href="https://www.php.net/manual/vote-note.php?id=78320&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd78320">
    <a href="https://www.php.net/manual/vote-note.php?id=78320&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V78320" title="100% like this...">
    3
    </div>
  </div>
  <a href="function.flock.php.html#78320" class="name">
  <strong class="user"><em>Antti Haapala</em></strong></a><a class="genanchor" href="function.flock.php.html#78320"> &para;</a><div class="date" title="2007-10-06 04:30"><strong>16 years ago</strong></div>
  <div class="text" id="Hcom78320">
<div class="phpcode"><code><span class="html">Further information on flock: The system is not restarted if a signal is delivered to the process, so flock will happily return false in case of SIGALRM, SIGFPE or something else.</span></code></div>
  </div>
 </div>
  <div class="note" id="120874">  <div class="votes">
    <div id="Vu120874">
    <a href="https://www.php.net/manual/vote-note.php?id=120874&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd120874">
    <a href="https://www.php.net/manual/vote-note.php?id=120874&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V120874" title="91% like this...">
    10
    </div>
  </div>
  <a href="function.flock.php.html#120874" class="name">
  <strong class="user"><em>jlh at gmx dot ch</em></strong></a><a class="genanchor" href="function.flock.php.html#120874"> &para;</a><div class="date" title="2017-03-27 06:14"><strong>6 years ago</strong></div>
  <div class="text" id="Hcom120874">
<div class="phpcode"><code><span class="html">When a file is closed the lock will be released by the system anyway, even if PHP doesn't do it explicitly anymore since 5.3.2 (the documentation is very confusing about this).<br /><br />However, I had a situation on an apache/PHP server where an out-of-memory error in PHP caused file handles to not be closed and therefore the locks where kept even thought PHP execution had ended and the process had returned to apache to serve other requests. The lock was kept alive until apache recycled those processes.<br /><br />This lack of proper clean up basically makes flock() completely unreliable.</span></code></div>
  </div>
 </div>
  <div class="note" id="100864">  <div class="votes">
    <div id="Vu100864">
    <a href="https://www.php.net/manual/vote-note.php?id=100864&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd100864">
    <a href="https://www.php.net/manual/vote-note.php?id=100864&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V100864" title="79% like this...">
    14
    </div>
  </div>
  <a href="function.flock.php.html#100864" class="name">
  <strong class="user"><em>webmaster at bitpush dot com</em></strong></a><a class="genanchor" href="function.flock.php.html#100864"> &para;</a><div class="date" title="2010-11-11 08:31"><strong>13 years ago</strong></div>
  <div class="text" id="Hcom100864">
<div class="phpcode"><code><span class="html">Regarding the change in PHP 5.3.2 with locked files:<br /><br />Without having studied the PHP source code in detail, the situation appears to be as follows when the PHP function fclose() is called:<br /><br />Before 5.3.2 PHP would check if the file was locked, then release the lock, and then close the file.<br /><br />From 5.3.2 PHP just closes the file.<br /><br />But note, that the operating system releases the lock automatically when the file is closed. Therefore a call to fclose() STILL releases the lock (this is tested with PHP 5.3.2, Linux, x64).</span></code></div>
  </div>
 </div>
  <div class="note" id="109237">  <div class="votes">
    <div id="Vu109237">
    <a href="https://www.php.net/manual/vote-note.php?id=109237&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd109237">
    <a href="https://www.php.net/manual/vote-note.php?id=109237&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V109237" title="75% like this...">
    18
    </div>
  </div>
  <a href="function.flock.php.html#109237" class="name">
  <strong class="user"><em>mdessaintes at gmail dot com</em></strong></a><a class="genanchor" href="function.flock.php.html#109237"> &para;</a><div class="date" title="2012-06-28 04:30"><strong>11 years ago</strong></div>
  <div class="text" id="Hcom109237">
<div class="phpcode"><code><span class="html">I just spent some time (again) to understand why a reading with file_get_contents() and file was returning me an empty string "" or array() whereas the file was existing and the contents not empty.<br /><br />In fact, i was locking file when writing it (file_put_contents third arg) but not testing if file was locked when reading it (and the file was accessed a lot).<br /><br />So, please pay attention that file_get_contents(), file() and maybe others php files functions are going to return empty data like if the contents of the file was an empty string.<br /><br />To avoid this problem, you have to set a LOCK_SH on your file before reading it (and then waiting if locked).<br /><br />Something like this :<br /><br /><span class="default">&lt;?php<br /></span><span class="keyword">public static function </span><span class="default">getContents</span><span class="keyword">(</span><span class="default">$path</span><span class="keyword">, </span><span class="default">$waitIfLocked </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">) {<br />    if(!</span><span class="default">file_exists</span><span class="keyword">(</span><span class="default">$path</span><span class="keyword">)) {<br />        throw new </span><span class="default">Exception</span><span class="keyword">(</span><span class="string">'File "'</span><span class="keyword">.</span><span class="default">$path</span><span class="keyword">.</span><span class="string">'" does not exists'</span><span class="keyword">);<br />    }<br />    else {<br />        </span><span class="default">$fo </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$path</span><span class="keyword">, </span><span class="string">'r'</span><span class="keyword">);<br />        </span><span class="default">$locked </span><span class="keyword">= </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fo</span><span class="keyword">, </span><span class="default">LOCK_SH</span><span class="keyword">, </span><span class="default">$waitIfLocked</span><span class="keyword">);<br />        <br />        if(!</span><span class="default">$locked</span><span class="keyword">) {<br />            return </span><span class="default">false</span><span class="keyword">;<br />        }<br />        else {<br />            </span><span class="default">$cts </span><span class="keyword">= </span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="default">$path</span><span class="keyword">);<br />            <br />            </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fo</span><span class="keyword">, </span><span class="default">LOCK_UN</span><span class="keyword">);<br />            </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fo</span><span class="keyword">);<br />            <br />            return </span><span class="default">$cts</span><span class="keyword">;<br />        }<br />    }<br />}<br /></span><span class="default">?&gt;<br /></span><br />Code to test by yourself :<br /><br />abc.txt :<br />someText<br /><br />file.php :<br /><span class="default">&lt;?php<br />$fo </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'abc.txt'</span><span class="keyword">, </span><span class="string">'r+'</span><span class="keyword">);<br /><br /></span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fo</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">);<br /></span><span class="default">sleep</span><span class="keyword">(</span><span class="default">10</span><span class="keyword">);<br /></span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fo</span><span class="keyword">, </span><span class="default">LOCK_UN</span><span class="keyword">);<br /></span><span class="default">?&gt;<br /></span><br />file2.php : <br /><span class="default">&lt;?php<br />var_dump</span><span class="keyword">(</span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="string">'abc.txt'</span><span class="keyword">));<br /></span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">file</span><span class="keyword">(</span><span class="string">'abc.txt'</span><span class="keyword">));<br /></span><span class="default">?&gt;<br /></span><br />Then launch file.php and switch to file2.php during the 10 seconds and see the difference before/after</span></code></div>
  </div>
 </div>
  <div class="note" id="117162">  <div class="votes">
    <div id="Vu117162">
    <a href="https://www.php.net/manual/vote-note.php?id=117162&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd117162">
    <a href="https://www.php.net/manual/vote-note.php?id=117162&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V117162" title="76% like this...">
    11
    </div>
  </div>
  <a href="function.flock.php.html#117162" class="name">
  <strong class="user"><em>forzi at mail333 dot com</em></strong></a><a class="genanchor" href="function.flock.php.html#117162"> &para;</a><div class="date" title="2015-04-24 06:34"><strong>8 years ago</strong></div>
  <div class="text" id="Hcom117162">
<div class="phpcode"><code><span class="html">Simple Helper for lock files creation<br /><br /><span class="default">&lt;?php<br /><br /></span><span class="keyword">class </span><span class="default">FileLocker </span><span class="keyword">{<br />    protected static </span><span class="default">$loc_files </span><span class="keyword">= array();<br /><br />    public static function </span><span class="default">lockFile</span><span class="keyword">(</span><span class="default">$file_name</span><span class="keyword">, </span><span class="default">$wait </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">) {<br />        </span><span class="default">$loc_file </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$file_name</span><span class="keyword">, </span><span class="string">'c'</span><span class="keyword">);<br />        if ( !</span><span class="default">$loc_file </span><span class="keyword">) {<br />            throw new </span><span class="default">\Exception</span><span class="keyword">(</span><span class="string">'Can\'t create lock file!'</span><span class="keyword">);<br />        }<br />        if ( </span><span class="default">$wait </span><span class="keyword">) {<br />            </span><span class="default">$lock </span><span class="keyword">= </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$loc_file</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">);<br />        } else {<br />            </span><span class="default">$lock </span><span class="keyword">= </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$loc_file</span><span class="keyword">, </span><span class="default">LOCK_EX </span><span class="keyword">| </span><span class="default">LOCK_NB</span><span class="keyword">);<br />        }<br />        if ( </span><span class="default">$lock </span><span class="keyword">) {<br />            </span><span class="default">self</span><span class="keyword">::</span><span class="default">$loc_files</span><span class="keyword">[</span><span class="default">$file_name</span><span class="keyword">] = </span><span class="default">$loc_file</span><span class="keyword">;<br />            </span><span class="default">fprintf</span><span class="keyword">(</span><span class="default">$loc_file</span><span class="keyword">, </span><span class="string">"%s\n"</span><span class="keyword">, </span><span class="default">getmypid</span><span class="keyword">());<br />            return </span><span class="default">$loc_file</span><span class="keyword">;<br />        } else if ( </span><span class="default">$wait </span><span class="keyword">) {<br />            throw new </span><span class="default">\Exception</span><span class="keyword">(</span><span class="string">'Can\'t lock file!'</span><span class="keyword">);<br />        } else {<br />            return </span><span class="default">false</span><span class="keyword">;<br />        }<br />    }<br /><br />    public static function </span><span class="default">unlockFile</span><span class="keyword">(</span><span class="default">$file_name</span><span class="keyword">) {<br />        </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">self</span><span class="keyword">::</span><span class="default">$loc_files</span><span class="keyword">[</span><span class="default">$file_name</span><span class="keyword">]);<br />        @</span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$file_name</span><span class="keyword">);<br />        unset(</span><span class="default">self</span><span class="keyword">::</span><span class="default">$loc_files</span><span class="keyword">[</span><span class="default">$file_name</span><span class="keyword">]);<br />    }<br /><br />} <br /><br />if ( !</span><span class="default">FileLocker</span><span class="keyword">::</span><span class="default">lockFile</span><span class="keyword">(</span><span class="string">'/tmp/1.lock'</span><span class="keyword">) ) {<br />    echo </span><span class="string">"Can't lock file\n"</span><span class="keyword">;<br />    die();<br />}<br /></span><span class="default">sleep</span><span class="keyword">(</span><span class="default">10</span><span class="keyword">);<br /></span><span class="default">FileLocker</span><span class="keyword">::</span><span class="default">unlockFile</span><span class="keyword">(</span><span class="string">'/tmp/1.lock'</span><span class="keyword">);<br />echo </span><span class="string">"All Ok\n"</span><span class="keyword">;</span></span></code></div>
  </div>
 </div>
  <div class="note" id="88907">  <div class="votes">
    <div id="Vu88907">
    <a href="https://www.php.net/manual/vote-note.php?id=88907&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd88907">
    <a href="https://www.php.net/manual/vote-note.php?id=88907&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V88907" title="76% like this...">
    11
    </div>
  </div>
  <a href="function.flock.php.html#88907" class="name">
  <strong class="user"><em>Fernando Gabrieli fgabrieli at gmail</em></strong></a><a class="genanchor" href="function.flock.php.html#88907"> &para;</a><div class="date" title="2009-02-12 11:06"><strong>15 years ago</strong></div>
  <div class="text" id="Hcom88907">
<div class="phpcode"><code><span class="html">When writing to a file, you should avoid using w+ because it would erase the contents of the file before locking<br /><br />If you need to write the complete file again you could use the following instead:<br /><br /><span class="default">&lt;?php<br />$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'yourfile.txt'</span><span class="keyword">, </span><span class="string">'a'</span><span class="keyword">) ;<br /><br />if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">)) {<br />    </span><span class="default">ftruncate</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">) ; </span><span class="comment">// &lt;-- this will erase the contents such as 'w+'<br />    <br />    </span><span class="default">fputs</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">'test string'</span><span class="keyword">) ;<br />    <br />    </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_UN</span><span class="keyword">) ;<br />}<br /><br /></span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">) ;<br /></span><span class="default">?&gt;<br /></span><br />Best,<br />Fernando Gabrieli</span></code></div>
  </div>
 </div>
  <div class="note" id="95257">  <div class="votes">
    <div id="Vu95257">
    <a href="https://www.php.net/manual/vote-note.php?id=95257&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd95257">
    <a href="https://www.php.net/manual/vote-note.php?id=95257&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V95257" title="72% like this...">
    10
    </div>
  </div>
  <a href="function.flock.php.html#95257" class="name">
  <strong class="user"><em>dejangex at yahoo dot com</em></strong></a><a class="genanchor" href="function.flock.php.html#95257"> &para;</a><div class="date" title="2009-12-21 01:47"><strong>14 years ago</strong></div>
  <div class="text" id="Hcom95257">
<div class="phpcode"><code><span class="html">Actually, there is no use of the while loop with the usleep. My testing has revealed the following:<br /><br /><span class="default">&lt;?php<br /></span><span class="comment">//some code here<br /></span><span class="default">flock</span><span class="keyword">(</span><span class="default">$file_handle</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">) </span><span class="comment">// &lt;- Your code will pause here untill you get the lock for indefinite amount of time or till your script times out<br />//some code here<br /></span><span class="default">?&gt;<br /></span><br />This will actually check for the lock without pausing and then it will sleep:<br /><br /><span class="default">&lt;?php<br /></span><span class="comment">//code here<br /></span><span class="keyword">while (!</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$file_handle</span><span class="keyword">, </span><span class="default">LOCK_EX </span><span class="keyword">| </span><span class="default">LOCK_NB</span><span class="keyword">)) {<br /> </span><span class="comment">//Lock not acquired, try again in:<br /> </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">round</span><span class="keyword">(</span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">, </span><span class="default">100</span><span class="keyword">)*</span><span class="default">1000</span><span class="keyword">)) </span><span class="comment">//0-100 miliseconds<br /></span><span class="keyword">}<br /></span><span class="comment">//lock acquired<br />//rest of the code<br /></span><span class="default">?&gt;<br /></span><br />The problem is, if you have a busy site and a lots of locking, the while loop may not acquire the lock for some time. Locking without LOCK_NB is much more persistent and it will wait for the lock for as long as it takes. It is almose guaranteed that the file will be locked, unless the script times out or something.<br /><br />Consider these two scripts: 1st one is ran, and the second one is ran 5 seconds after the first.<br /><br /><span class="default">&lt;?php<br /></span><span class="comment">//1st script<br /></span><span class="default">$file_handle </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'file.test'</span><span class="keyword">, </span><span class="string">'r+'</span><span class="keyword">);<br /></span><span class="default">flock</span><span class="keyword">(</span><span class="default">$file_handle</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">); </span><span class="comment">//lock the file<br /></span><span class="default">sleep</span><span class="keyword">(</span><span class="default">10</span><span class="keyword">); </span><span class="comment">//sleep 10 seconds<br /></span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$file_handle</span><span class="keyword">); </span><span class="comment">//close and unlock the file<br /></span><span class="default">?&gt;<br /></span><br /><span class="default">&lt;?php<br /></span><span class="comment">//2nd script<br /></span><span class="default">$file_handle </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'file.test'</span><span class="keyword">, </span><span class="string">'r+'</span><span class="keyword">);<br /></span><span class="default">flock</span><span class="keyword">(</span><span class="default">$file_handle</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">); </span><span class="comment">//lock the file<br /></span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$file_handle</span><span class="keyword">); </span><span class="comment">//close and unlock the file<br /></span><span class="default">?&gt;<br /></span><br />If you run 1st and then the 2nd script,the 2nd script will wait untill the 1st has finished. As soon as the first script finishes, the second one will acquire the lock and finish the execution. If you use flock($file_handle, LOCK_EX | LOCK_NB) in the 2nd script while the 1st script is running, it would finish execution immediately and you would not get the lock.</span></code></div>
  </div>
 </div>
  <div class="note" id="32443">  <div class="votes">
    <div id="Vu32443">
    <a href="https://www.php.net/manual/vote-note.php?id=32443&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd32443">
    <a href="https://www.php.net/manual/vote-note.php?id=32443&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V32443" title="72% like this...">
    5
    </div>
  </div>
  <a href="function.flock.php.html#32443" class="name">
  <strong class="user"><em>joel[at_sign]purerave.com</em></strong></a><a class="genanchor" href="function.flock.php.html#32443"> &para;</a><div class="date" title="2003-05-27 06:12"><strong>20 years ago</strong></div>
  <div class="text" id="Hcom32443">
<div class="phpcode"><code><span class="html">I have found that if you open a currently locked file with 'w' or 'w+' ("file pointer at the beginning of the file and truncate the file to zero length")  then it will not truncate the file when the lock is released and the file available.<br /><br />Example I used to test it:<br /><span class="default">&lt;?php<br /></span><span class="comment">// a.php<br /></span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">( </span><span class="string">"/tmp/lock.txt"</span><span class="keyword">, </span><span class="string">"w+" </span><span class="keyword">);<br /></span><span class="default">flock</span><span class="keyword">( </span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX </span><span class="keyword">); </span><span class="comment">// exclusive lock<br /><br /></span><span class="default">$steps </span><span class="keyword">= </span><span class="default">10</span><span class="keyword">;<br /></span><span class="comment">// write to the file<br /></span><span class="keyword">for (</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">&lt; </span><span class="default">$steps</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++) {<br />    </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">'a '</span><span class="keyword">.</span><span class="default">time</span><span class="keyword">().</span><span class="string">' test '</span><span class="keyword">. </span><span class="default">$i</span><span class="keyword">.</span><span class="string">"\n"</span><span class="keyword">);<br />    </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">);<br />}<br /></span><span class="default">flock</span><span class="keyword">( </span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_UN </span><span class="keyword">); </span><span class="comment">// release the lock<br /></span><span class="default">fclose</span><span class="keyword">( </span><span class="default">$fp </span><span class="keyword">);<br /></span><span class="default">?&gt;<br /></span><br />----------<br /><span class="default">&lt;?php<br /></span><span class="comment">// b.php<br /><br /></span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">( </span><span class="string">"/tmp/lock.txt"</span><span class="keyword">, </span><span class="string">"w+" </span><span class="keyword">);<br /></span><span class="default">flock</span><span class="keyword">( </span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX </span><span class="keyword">); </span><span class="comment">// exclusive lock<br /><br />// ftruncate($fp, 0) is needed here! &lt;----<br /><br /></span><span class="default">$steps </span><span class="keyword">= </span><span class="default">5</span><span class="keyword">;<br /></span><span class="comment">// write to the file<br /></span><span class="keyword">for (</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">&lt; </span><span class="default">$steps</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++) {<br />    </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">'b '</span><span class="keyword">.</span><span class="default">time</span><span class="keyword">().</span><span class="string">' test '</span><span class="keyword">. </span><span class="default">$i</span><span class="keyword">.</span><span class="string">"\n"</span><span class="keyword">);<br />    </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">);<br />}<br /></span><span class="default">flock</span><span class="keyword">( </span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_UN </span><span class="keyword">); </span><span class="comment">// release the lock<br /></span><span class="default">fclose</span><span class="keyword">( </span><span class="default">$fp </span><span class="keyword">);<br /></span><span class="default">?&gt;<br /></span><br />Loading a.php then loading b.php right after will result in:<br />b 1054075769 test 0<br />b 1054075770 test 1<br />b 1054075771 test 2<br />b 1054075772 test 3<br />b 1054075773 test 4<br />a 1054075764 test 5<br />a 1054075765 test 6<br />a 1054075766 test 7<br />a 1054075767 test 8<br />a 1054075768 test 9<br /><br />As you can see, b.php does not truncate the file as the w+ would suggest if the file were instantly available. But only moves the pointer to the begining of the file. If b.php was loaded after a.php finished then there would be no "a ..." lines in the file, since it would be truncated.<br /><br />To fix this you have to add ftruncate($fp, 0) right after the flock.<br /><br />'r+' and 'a' seem to work fine, though.</span></code></div>
  </div>
 </div>
  <div class="note" id="82521">  <div class="votes">
    <div id="Vu82521">
    <a href="https://www.php.net/manual/vote-note.php?id=82521&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd82521">
    <a href="https://www.php.net/manual/vote-note.php?id=82521&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V82521" title="70% like this...">
    7
    </div>
  </div>
  <a href="function.flock.php.html#82521" class="name">
  <strong class="user"><em>John dot wellesz at teaser dot fr</em></strong></a><a class="genanchor" href="function.flock.php.html#82521"> &para;</a><div class="date" title="2008-04-14 05:59"><strong>15 years ago</strong></div>
  <div class="text" id="Hcom82521">
<div class="phpcode"><code><span class="html">I just want to add a note about making atomic lock on NFS, there is only two<br />ways:<br /><br />- 1 (the most robust but the most complicate) - It's to use link() to create a<br />  hard link to a file you want to lock (on the same FS of course).<br />  (On most NFS implementations, Link() is atomic)<br /><br />Once you created a hard link (not a symbolic link), with a unique randomly<br />generated name, call stat() on it and count the number of link (nlink), if there<br />is only 2 then the file is locked.<br /><br />If there is more than two you have to unlink() the link you just created and<br />create a new one with a new unique name (else NFS will use its cache and stat<br />will return wrong data) then call stat() on the new link and test the number of<br />links again, repeat this operation until you get the lock.<br /><br />You have to use usleep() between the link() attempts with a fixed + random<br />sleep value to avoid dead lock situations (link() and unlink() may be atomic<br />but not instantaneous)<br /><br />Also note than when you unlink a file through NFS, if NFS think that the file<br />is still in use, it will create a .nfs link to this file until it realizes the<br />file is no longer in use... A wrong timing could generate thousands of those<br />files and a deadlock situation.  Because of this when a deadlock situation<br />occurs or if your stat() command returns a very high number of links, you have<br />to look for .nfs file in the same directory you created your links and unlink<br />all the .nfs file you find (sometimes NFS take its time to remove them)<br /><br />- 2 (the simplest) - the second method is to use a lock server and lock daemons<br />  on each client that will forward lock request to the server... (this is more<br />dangerous than the first method because the daemons may be killed...)<br /><br />Here is for reference the function I created to make atomic locks through NFS<br />(this function is in production since at least 4 years now), it's just for<br />reference because it uses many external functions to do its job but you can see<br />the principle:<br /><br /><a href="http://pastey.net/85793" rel="nofollow" target="_blank">http://pastey.net/85793</a></span></code></div>
  </div>
 </div>
  <div class="note" id="68875">  <div class="votes">
    <div id="Vu68875">
    <a href="https://www.php.net/manual/vote-note.php?id=68875&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd68875">
    <a href="https://www.php.net/manual/vote-note.php?id=68875&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V68875" title="71% like this...">
    3
    </div>
  </div>
  <a href="function.flock.php.html#68875" class="name">
  <strong class="user"><em>jerry at gh33 dot org</em></strong></a><a class="genanchor" href="function.flock.php.html#68875"> &para;</a><div class="date" title="2006-08-14 09:30"><strong>17 years ago</strong></div>
  <div class="text" id="Hcom68875">
<div class="phpcode"><code><span class="html">Indeed, flock() will not work reliably when the underlying filesystem is NFS. The proper way to perform file locking, in this case, would be to use PHP's link() function. From the Linux man page of open():<br /><br />       O_EXCL When used with O_CREAT, if the file  already  exists  it  is  an<br />              error  and  the open will fail. In this context, a symbolic link<br />              exists, regardless of where its points to.  O_EXCL is broken  on<br />              NFS file systems, programs which rely on it for performing lock-<br />              ing tasks will contain a race condition.  The solution for  per-<br />              forming  atomic  file  locking  using  a lockfile is to create a<br />              unique file on the same fs  (e.g.,  incorporating  hostname  and<br />              pid),  use  link(2)  to  make  a link to the lockfile. If link()<br />              returns 0, the lock is successful.  Otherwise,  use  stat(2)  on<br />              the  unique  file to check if its link count has increased to 2,<br />              in which case the lock is also successful.</span></code></div>
  </div>
 </div>
  <div class="note" id="111984">  <div class="votes">
    <div id="Vu111984">
    <a href="https://www.php.net/manual/vote-note.php?id=111984&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd111984">
    <a href="https://www.php.net/manual/vote-note.php?id=111984&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V111984" title="66% like this...">
    7
    </div>
  </div>
  <a href="function.flock.php.html#111984" class="name">
  <strong class="user"><em>metamarkers at gmail dot com</em></strong></a><a class="genanchor" href="function.flock.php.html#111984"> &para;</a><div class="date" title="2013-04-19 12:13"><strong>10 years ago</strong></div>
  <div class="text" id="Hcom111984">
<div class="phpcode"><code><span class="html">you can wrap a lock as an object to make it a scope-based lock. when the lock object is no longer referenced, like when it's unset or the owner returns, the destructor will call unlock.<br /><br />this way you can just create a lock object and forget about it.<br /><br /><span class="default">&lt;?php<br /></span><span class="keyword">class </span><span class="default">lock </span><span class="keyword">{<br /><br />    private </span><span class="default">$handle</span><span class="keyword">;<br /><br />    public static function </span><span class="default">read </span><span class="keyword">( </span><span class="default">$handle </span><span class="keyword">) {<br />        </span><span class="default">$lock </span><span class="keyword">= new static();<br />        </span><span class="default">$lock</span><span class="keyword">-&gt;</span><span class="default">handle </span><span class="keyword">= </span><span class="default">$handle</span><span class="keyword">;<br />        return </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">,</span><span class="default">LOCK_SH</span><span class="keyword">) ? </span><span class="default">$lock </span><span class="keyword">: </span><span class="default">false</span><span class="keyword">;<br />    }<br /><br />    public static function </span><span class="default">write </span><span class="keyword">( </span><span class="default">$handle </span><span class="keyword">) {<br />        </span><span class="default">$lock </span><span class="keyword">= new static();<br />        </span><span class="default">$lock</span><span class="keyword">-&gt;</span><span class="default">handle </span><span class="keyword">= </span><span class="default">$handle</span><span class="keyword">;<br />        return </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">,</span><span class="default">LOCK_EX</span><span class="keyword">) ? </span><span class="default">$lock </span><span class="keyword">: </span><span class="default">false</span><span class="keyword">;<br />    }<br /><br />    public function </span><span class="default">__destruct </span><span class="keyword">( ) {<br />        </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">handle</span><span class="keyword">,</span><span class="default">LOCK_UN</span><span class="keyword">);<br />    }<br /><br />}<br /></span><span class="default">?&gt;</span></span></code></div>
  </div>
 </div>
  <div class="note" id="84824">  <div class="votes">
    <div id="Vu84824">
    <a href="https://www.php.net/manual/vote-note.php?id=84824&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd84824">
    <a href="https://www.php.net/manual/vote-note.php?id=84824&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V84824" title="66% like this...">
    7
    </div>
  </div>
  <a href="function.flock.php.html#84824" class="name">
  <strong class="user"><em>tinymountain at nospam dot gmail dot com</em></strong></a><a class="genanchor" href="function.flock.php.html#84824"> &para;</a><div class="date" title="2008-07-31 01:36"><strong>15 years ago</strong></div>
  <div class="text" id="Hcom84824">
<div class="phpcode"><code><span class="html">Here's a handy class to allow retrying a write with flock a set number of times. If it can't flock, it will sleep for a brief random interval and try again. If you have a lot of concurrent writes going on, you can use it to avoid data corruption.<br /><br /><span class="default">&lt;?php<br /></span><span class="keyword">class </span><span class="default">SafeWriter<br /></span><span class="keyword">{<br />    </span><span class="comment">// suggested mode 'a' for writing to the end of the file<br />    </span><span class="keyword">public static function </span><span class="default">writeData</span><span class="keyword">(</span><span class="default">$path</span><span class="keyword">, </span><span class="default">$mode</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">)<br />    {<br />        </span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$path</span><span class="keyword">, </span><span class="default">$mode</span><span class="keyword">);<br />        </span><span class="default">$retries </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />        </span><span class="default">$max_retries </span><span class="keyword">= </span><span class="default">100</span><span class="keyword">;<br /><br />        if (!</span><span class="default">$fp</span><span class="keyword">) {<br />            </span><span class="comment">// failure<br />            </span><span class="keyword">return </span><span class="default">false</span><span class="keyword">;<br />        }<br /><br />        </span><span class="comment">// keep trying to get a lock as long as possible<br />        </span><span class="keyword">do {<br />            if (</span><span class="default">$retries </span><span class="keyword">&gt; </span><span class="default">0</span><span class="keyword">) {<br />                </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">rand</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">, </span><span class="default">10000</span><span class="keyword">));<br />            }<br />            </span><span class="default">$retries </span><span class="keyword">+= </span><span class="default">1</span><span class="keyword">;<br />        } while (!</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">) and </span><span class="default">$retries </span><span class="keyword">&lt;= </span><span class="default">$max_retries</span><span class="keyword">);<br /><br />        </span><span class="comment">// couldn't get the lock, give up<br />        </span><span class="keyword">if (</span><span class="default">$retries </span><span class="keyword">== </span><span class="default">$max_retries</span><span class="keyword">) {<br />            </span><span class="comment">// failure<br />            </span><span class="keyword">return </span><span class="default">false</span><span class="keyword">;<br />        }<br /><br />        </span><span class="comment">// got the lock, write the data<br />        </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">"</span><span class="default">$data</span><span class="string">\n"</span><span class="keyword">);<br />        </span><span class="comment">// release the lock<br />        </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_UN</span><span class="keyword">);<br />        </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />        </span><span class="comment">// success<br />        </span><span class="keyword">return </span><span class="default">true</span><span class="keyword">;<br />    }<br />}<br /></span><span class="default">?&gt;</span></span></code></div>
  </div>
 </div>
  <div class="note" id="101226">  <div class="votes">
    <div id="Vu101226">
    <a href="https://www.php.net/manual/vote-note.php?id=101226&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd101226">
    <a href="https://www.php.net/manual/vote-note.php?id=101226&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V101226" title="66% like this...">
    2
    </div>
  </div>
  <a href="function.flock.php.html#101226" class="name">
  <strong class="user"><em>holdoffhunger at gmail dot com</em></strong></a><a class="genanchor" href="function.flock.php.html#101226"> &para;</a><div class="date" title="2010-12-03 07:53"><strong>13 years ago</strong></div>
  <div class="text" id="Hcom101226">
<div class="phpcode"><code><span class="html">I've been having trouble getting Flock to work when I read a file, delete it, and then output slightly changed information back to the same location.  When deleting with Unlink, there's a very brief period of time where no file exists.  But, if you do an fopen using the "w" mode, it keeps the file in existence, but deletes all of its data when you go to write to it.  That way, the file never actually disappears, and another script accessing the same file with flock won't get a "file doesn't exist" error.</span></code></div>
  </div>
 </div>
  <div class="note" id="80006">  <div class="votes">
    <div id="Vu80006">
    <a href="https://www.php.net/manual/vote-note.php?id=80006&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd80006">
    <a href="https://www.php.net/manual/vote-note.php?id=80006&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V80006" title="66% like this...">
    2
    </div>
  </div>
  <a href="function.flock.php.html#80006" class="name">
  <strong class="user"><em>admin ifyouwantblood de</em></strong></a><a class="genanchor" href="function.flock.php.html#80006"> &para;</a><div class="date" title="2007-12-23 07:05"><strong>16 years ago</strong></div>
  <div class="text" id="Hcom80006">
<div class="phpcode"><code><span class="html">besides from what the manual says about locking a file opendend in w or w+ and using a special lock file for these cases, you should simply truncate the file yourself with ftruncate() after writing:<br /><br /><span class="default">&lt;?php<br /><br />$data</span><span class="keyword">=</span><span class="string">'some data'</span><span class="keyword">;<br /></span><span class="default">$handle</span><span class="keyword">=</span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'file'</span><span class="keyword">,</span><span class="string">'r+'</span><span class="keyword">);<br /></span><span class="default">flock</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">,</span><span class="default">LOCK_EX</span><span class="keyword">);<br /></span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">,</span><span class="default">$data</span><span class="keyword">);<br /></span><span class="default">ftruncate</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">,</span><span class="default">ftell</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">));<br /></span><span class="default">flock</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">,</span><span class="default">LOCK_UN</span><span class="keyword">);<br /></span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">);<br /><br /></span><span class="default">?&gt;<br /></span><br />now the file will have the size of $data without opening the file in w mode but with a lock on the file.<br /><br />to the previous writers jpriebe and mallory:<br />of course the lock is lost in this case, but thats simply because the file is closed by PHP. and closing the file means unlocking it (same as when you use fclose() yourself).</span></code></div>
  </div>
 </div>
  <div class="note" id="55664">  <div class="votes">
    <div id="Vu55664">
    <a href="https://www.php.net/manual/vote-note.php?id=55664&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd55664">
    <a href="https://www.php.net/manual/vote-note.php?id=55664&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V55664" title="66% like this...">
    2
    </div>
  </div>
  <a href="function.flock.php.html#55664" class="name">
  <strong class="user"><em>damasta at onwebworx dot net</em></strong></a><a class="genanchor" href="function.flock.php.html#55664"> &para;</a><div class="date" title="2005-08-09 08:28"><strong>18 years ago</strong></div>
  <div class="text" id="Hcom55664">
<div class="phpcode"><code><span class="html">just wanted to say that you will most likely fail if you use a separate lock file together with register_shutdown_function.<br /><br />my script did some different actions... resizing pictures, rotating them and this stuff. it needed a "database" file to get the correct file locations. this database file also stored some flags. and of course the script had to save that file when it was done.<br /><br />because of my script exited on many different points depending on the action i used register_shutdown_function to save the file. it wanted to use a locking system to be sure the script doesn't overwrite the data another process had written into it some microseconds before. i was running on windows 2000 and apache2 on my developing machine, and flock always returned true for some reason... so i used a separate lock file. the script looked for it at the beginning and exited if it was found. otherwise it created it. but this file had to be deleted at the end. i put the unlink command into the registered shutdown-function but it never deleted the file. i tried clearstatcache and some other stuff but it didn't help.<br /><br />maybe this helps someone.</span></code></div>
  </div>
 </div>
  <div class="note" id="43705">  <div class="votes">
    <div id="Vu43705">
    <a href="https://www.php.net/manual/vote-note.php?id=43705&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd43705">
    <a href="https://www.php.net/manual/vote-note.php?id=43705&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V43705" title="66% like this...">
    1
    </div>
  </div>
  <a href="function.flock.php.html#43705" class="name">
  <strong class="user"><em>Joby &lt;god at NOSPAMPLEASE dot greentinted dot net&gt;</em></strong></a><a class="genanchor" href="function.flock.php.html#43705"> &para;</a><div class="date" title="2004-06-30 05:59"><strong>19 years ago</strong></div>
  <div class="text" id="Hcom43705">
<div class="phpcode"><code><span class="html">I'm thinking that a good way to ensure that no data is lost would be to create a buffer directory that could store the instructions for what is to be written to a file, then whenever the file is decidedly unlocked, a single execution could loop through every file in that directory and apply the indicated changes to the file.<br /><br />I'm working on writing this for a flat-file based database.  The way it works is, whenever a command is issued (addline, removeline, editline), the command is stored in a flat file stored in a folder named a shortened version of the filename to be edited and named by the time and a random number.  In that file is a standardized set of commands that define what is to be done to what file (the likes of "file: SecuraLog/index_uid" new line "editline: 14").<br /><br />Each execution will check every folder in that directory for files and a certain amount of time (I don't know how long, maybe 1-2 seconds) is spent making pending changes to unlocked files.  This way no changes will be lost (i.e. person 1 makes a change at the same time as person 2, and person 1 loses the race by just enough to have their changed version of the file overwritten by person 2's version) and there will be no problems with opening an empty open file.</span></code></div>
  </div>
 </div>
  <div class="note" id="45464">  <div class="votes">
    <div id="Vu45464">
    <a href="https://www.php.net/manual/vote-note.php?id=45464&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd45464">
    <a href="https://www.php.net/manual/vote-note.php?id=45464&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V45464" title="63% like this...">
    3
    </div>
  </div>
  <a href="function.flock.php.html#45464" class="name">
  <strong class="user"><em>rudy dot metzger at pareto dot nl</em></strong></a><a class="genanchor" href="function.flock.php.html#45464"> &para;</a><div class="date" title="2004-09-08 03:31"><strong>19 years ago</strong></div>
  <div class="text" id="Hcom45464">
<div class="phpcode"><code><span class="html">Like a user already noted, most Linux kernels (at least the Redhat ones) will return false, even if you locked the file. This is because the lock is only ADVISORY (you can check that in /proc/locks). What you have to do there is to evalute the 3rd parameter of flock(), $eWouldBlock. See for an example below. Note however that if you<br />lock the file in non blocking mode, flock() will work as expected (and blocks the script).<br /><br /><span class="default">&lt;?php<br />                                                                                <br />$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">( </span><span class="string">"/var/lock/process.pid"</span><span class="keyword">, </span><span class="string">"a" </span><span class="keyword">);<br />if ( !</span><span class="default">$fp </span><span class="keyword">|| !</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">,</span><span class="default">LOCK_EX</span><span class="keyword">|</span><span class="default">LOCK_NB</span><span class="keyword">,</span><span class="default">$eWouldBlock</span><span class="keyword">) || </span><span class="default">$eWouldBlock </span><span class="keyword">) {<br />  </span><span class="default">fputs</span><span class="keyword">( </span><span class="default">STDERR</span><span class="keyword">, </span><span class="string">"Failed to acquire lock!\n" </span><span class="keyword">);<br />  exit;<br />}<br />                                                                                <br /></span><span class="comment">// do your work here<br />                                                                                <br /></span><span class="default">fclose</span><span class="keyword">( </span><span class="default">$fp </span><span class="keyword">);<br /></span><span class="default">unlink</span><span class="keyword">( </span><span class="string">"/var/lock/process.pid" </span><span class="keyword">);<br />                                                                                <br /></span><span class="default">?&gt;</span></span></code></div>
  </div>
 </div>
  <div class="note" id="107939">  <div class="votes">
    <div id="Vu107939">
    <a href="https://www.php.net/manual/vote-note.php?id=107939&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd107939">
    <a href="https://www.php.net/manual/vote-note.php?id=107939&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V107939" title="62% like this...">
    2
    </div>
  </div>
  <a href="function.flock.php.html#107939" class="name">
  <strong class="user"><em>ondrej dot nemecek at gmail dot com</em></strong></a><a class="genanchor" href="function.flock.php.html#107939"> &para;</a><div class="date" title="2012-03-15 03:15"><strong>11 years ago</strong></div>
  <div class="text" id="Hcom107939">
<div class="phpcode"><code><span class="html">Notice: On NFS with NFS locking daemon you cannot open file for reading and than lock exklusively:<br /><br />$rFopened  = fopen($sFile,'r');<br />$bResult   = flock($rFopened, LOCK_EX);<br /><br />var_dump($bResult); // returns FALSE<br /><br />Mixed fopen modes (a+, w+ ...) works with LOCK_EX fine.</span></code></div>
  </div>
 </div>
  <div class="note" id="120274">  <div class="votes">
    <div id="Vu120274">
    <a href="https://www.php.net/manual/vote-note.php?id=120274&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd120274">
    <a href="https://www.php.net/manual/vote-note.php?id=120274&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V120274" title="60% like this...">
    2
    </div>
  </div>
  <a href="function.flock.php.html#120274" class="name">
  <strong class="user"><em>markus at malkusch dot de</em></strong></a><a class="genanchor" href="function.flock.php.html#120274"> &para;</a><div class="date" title="2016-12-04 07:20"><strong>7 years ago</strong></div>
  <div class="text" id="Hcom120274">
<div class="phpcode"><code><span class="html">And here's the timeout template for UNIX:<br /><br /><span class="default">&lt;?php<br />pcntl_signal</span><span class="keyword">(</span><span class="default">SIGALRM</span><span class="keyword">, function() {});<br /></span><span class="default">pcntl_alarm</span><span class="keyword">(</span><span class="default">3</span><span class="keyword">);<br />try {<br />    if (!</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">)) {<br />        throw new </span><span class="default">\Exception</span><span class="keyword">(</span><span class="string">"Timeout"</span><span class="keyword">);<br />    }<br />} finally {<br />    </span><span class="default">pcntl_alarm</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">);<br />    </span><span class="default">pcntl_signal_dispatch</span><span class="keyword">();<br />    </span><span class="default">pcntl_signal</span><span class="keyword">(</span><span class="default">SIGALRM</span><span class="keyword">, </span><span class="default">SIG_DFL</span><span class="keyword">);<br />}<br /></span><span class="default">?&gt;</span></span></code></div>
  </div>
 </div>
  <div class="note" id="79913">  <div class="votes">
    <div id="Vu79913">
    <a href="https://www.php.net/manual/vote-note.php?id=79913&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd79913">
    <a href="https://www.php.net/manual/vote-note.php?id=79913&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V79913" title="60% like this...">
    1
    </div>
  </div>
  <a href="function.flock.php.html#79913" class="name">
  <strong class="user"><em>mallory dot dessaintes at gmail dot com</em></strong></a><a class="genanchor" href="function.flock.php.html#79913"> &para;</a><div class="date" title="2007-12-19 07:56"><strong>16 years ago</strong></div>
  <div class="text" id="Hcom79913">
<div class="phpcode"><code><span class="html">I have noticed that if you change the value of your fopen ressource, the lock is working no longer..<br /><br /><span class="default">&lt;?php<br /><br />$fo </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'lockfile.txt'</span><span class="keyword">,</span><span class="string">'a'</span><span class="keyword">);<br /><br /></span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fo</span><span class="keyword">,</span><span class="default">LOCK_EX</span><span class="keyword">);<br /><br /></span><span class="default">$fo </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br /><br /></span><span class="comment">// Lock is disable<br /><br /></span><span class="default">?&gt;</span></span></code></div>
  </div>
 </div>
  <div class="note" id="61921">  <div class="votes">
    <div id="Vu61921">
    <a href="https://www.php.net/manual/vote-note.php?id=61921&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd61921">
    <a href="https://www.php.net/manual/vote-note.php?id=61921&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V61921" title="60% like this...">
    1
    </div>
  </div>
  <a href="function.flock.php.html#61921" class="name">
  <strong class="user"><em>marc dot vanwoerkom at fernuni-hagen dot de</em></strong></a><a class="genanchor" href="function.flock.php.html#61921"> &para;</a><div class="date" title="2006-02-15 02:00"><strong>17 years ago</strong></div>
  <div class="text" id="Hcom61921">
<div class="phpcode"><code><span class="html">I ran into a loop because I just checked for true (= you got the lock) as return value of flock() and tried again when I got a false.<br /><br /><span class="default">&lt;?php<br />    </span><span class="keyword">function </span><span class="default">naive_wait_for_file</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">) {<br />        while (</span><span class="default">true</span><span class="keyword">) {<br />            if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">)) {<br />                return;<br />            }<br />            </span><span class="default">$k </span><span class="keyword">= </span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">, </span><span class="default">20</span><span class="keyword">);<br />            </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">round</span><span class="keyword">(</span><span class="default">$k </span><span class="keyword">* </span><span class="default">10000</span><span class="keyword">));  </span><span class="comment"># k * 10ms<br />        </span><span class="keyword">}<br />    }<br /></span><span class="default">?&gt;<br /></span><br />Unfortunately in one case the $fp I put in was invalid, so I always got false and got stuck.<br />Lesson: check if your $fp is valid before entering the loop, or look closer if you get a false.<br /><br /><span class="default">&lt;?php<br />    </span><span class="keyword">function </span><span class="default">wait_for_file</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">) {<br />        if (</span><span class="default">$fp </span><span class="keyword">=== </span><span class="default">false</span><span class="keyword">) {<br />            return;<br />        }<br />        while (</span><span class="default">true</span><span class="keyword">) {<br />            if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">)) {<br />                return;<br />            }<br />            </span><span class="default">$k </span><span class="keyword">= </span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">, </span><span class="default">20</span><span class="keyword">);<br />            </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">round</span><span class="keyword">(</span><span class="default">$k </span><span class="keyword">* </span><span class="default">10000</span><span class="keyword">));  </span><span class="comment"># k * 10ms<br />        </span><span class="keyword">}<br />    }<br /></span><span class="default">?&gt;</span></span></code></div>
  </div>
 </div>
  <div class="note" id="92731">  <div class="votes">
    <div id="Vu92731">
    <a href="https://www.php.net/manual/vote-note.php?id=92731&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd92731">
    <a href="https://www.php.net/manual/vote-note.php?id=92731&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V92731" title="57% like this...">
    1
    </div>
  </div>
  <a href="function.flock.php.html#92731" class="name">
  <strong class="user"><em>Kuzma dot Deretuke at gmail dot com</em></strong></a><a class="genanchor" href="function.flock.php.html#92731"> &para;</a><div class="date" title="2009-08-06 04:31"><strong>14 years ago</strong></div>
  <div class="text" id="Hcom92731">
<div class="phpcode"><code><span class="html">I use exclusive writing to replace standard flock():<br /><br /><span class="default">&lt;?php<br /></span><span class="comment">// get/set lock file name<br /></span><span class="keyword">function </span><span class="default">m_lock_file</span><span class="keyword">( </span><span class="default">$format </span><span class="keyword">= </span><span class="default">null </span><span class="keyword">) {<br />    static </span><span class="default">$file_format </span><span class="keyword">= </span><span class="string">'./%s.lock'</span><span class="keyword">;<br />    <br />    if (</span><span class="default">$format </span><span class="keyword">!== </span><span class="default">null</span><span class="keyword">) {<br />        </span><span class="default">$file_format </span><span class="keyword">= </span><span class="default">$format</span><span class="keyword">;<br />    }<br />    <br />    return </span><span class="default">$file_format</span><span class="keyword">;<br />}<br /><br /></span><span class="comment">// acquire/check/release lock<br /></span><span class="keyword">function </span><span class="default">m_lock</span><span class="keyword">( </span><span class="default">$lockId</span><span class="keyword">, </span><span class="default">$acquire </span><span class="keyword">= </span><span class="default">null </span><span class="keyword">) {<br />    static </span><span class="default">$handlers </span><span class="keyword">= array();<br />    <br />    if (</span><span class="default">is_bool</span><span class="keyword">(</span><span class="default">$acquire</span><span class="keyword">)) {<br />        </span><span class="default">$file </span><span class="keyword">= </span><span class="default">sprintf</span><span class="keyword">(</span><span class="default">m_lock_file</span><span class="keyword">(), </span><span class="default">md5</span><span class="keyword">(</span><span class="default">$lockId</span><span class="keyword">), </span><span class="default">$lockId</span><span class="keyword">);<br />    }<br />    <br />    if (</span><span class="default">$acquire </span><span class="keyword">=== </span><span class="default">false</span><span class="keyword">) {<br />        if (isset(</span><span class="default">$handlers</span><span class="keyword">[</span><span class="default">$lockId</span><span class="keyword">])) {<br />            @</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$handlers</span><span class="keyword">[</span><span class="default">$lockId</span><span class="keyword">]);<br />            @</span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">);<br />            unset(</span><span class="default">$handlers</span><span class="keyword">[</span><span class="default">$lockId</span><span class="keyword">]);<br />        } else {<br />            </span><span class="default">trigger_error</span><span class="keyword">(</span><span class="string">"Lock '</span><span class="default">$lockId</span><span class="string">' is already unlocked"</span><span class="keyword">, </span><span class="default">E_USER_WARNING</span><span class="keyword">);<br />        }<br />    }<br />    <br />    if (</span><span class="default">$acquire </span><span class="keyword">=== </span><span class="default">true</span><span class="keyword">) {<br />        if (!isset(</span><span class="default">$handlers</span><span class="keyword">[</span><span class="default">$lockId</span><span class="keyword">])) {<br />            </span><span class="default">$handler </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />            </span><span class="default">$count </span><span class="keyword">= </span><span class="default">100</span><span class="keyword">;<br />            do {<br />                if (!</span><span class="default">file_exists</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">) || @</span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">)) {<br />                    </span><span class="default">$handler </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">, </span><span class="string">"x"</span><span class="keyword">);<br />                }<br />                if (</span><span class="default">false </span><span class="keyword">=== </span><span class="default">$handler</span><span class="keyword">) {<br />                    </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">10000</span><span class="keyword">);<br />                } else {<br />                    </span><span class="default">$handlers</span><span class="keyword">[</span><span class="default">$lockId</span><span class="keyword">] = </span><span class="default">$handler</span><span class="keyword">;<br />                }<br />            } while (</span><span class="default">false </span><span class="keyword">=== </span><span class="default">$handler </span><span class="keyword">&amp;&amp; </span><span class="default">$count</span><span class="keyword">-- &gt; </span><span class="default">0</span><span class="keyword">);<br />        } else {<br />            </span><span class="default">trigger_error</span><span class="keyword">(</span><span class="string">"Lock '</span><span class="default">$lockId</span><span class="string">' is already locked"</span><span class="keyword">, </span><span class="default">E_USER_WARNING</span><span class="keyword">);<br />        }<br />    }<br />    <br />    return isset(</span><span class="default">$handlers</span><span class="keyword">[</span><span class="default">$lockId</span><span class="keyword">]);<br />}<br /></span><span class="default">?&gt;<br /></span><br />Usage sample:<br /><br /><span class="default">&lt;?php<br />$lockId </span><span class="keyword">= </span><span class="string">"qq"</span><span class="keyword">;<br /><br /></span><span class="default">m_lock</span><span class="keyword">(</span><span class="default">$lockId</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);<br />if (</span><span class="default">m_lock</span><span class="keyword">(</span><span class="default">$lockId</span><span class="keyword">)) {<br />    echo </span><span class="string">"locked"</span><span class="keyword">;<br /><br />    </span><span class="comment">// here you can perform any thread-safe operations<br />    </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">300 </span><span class="keyword">* </span><span class="default">1000</span><span class="keyword">);<br /><br />    </span><span class="default">m_lock</span><span class="keyword">(</span><span class="default">$lockId</span><span class="keyword">, </span><span class="default">false</span><span class="keyword">);<br />} else {<br />    echo </span><span class="string">"not locked"</span><span class="keyword">;<br />}<br /><br /></span><span class="default">?&gt;</span></span></code></div>
  </div>
 </div>
  <div class="note" id="118933">  <div class="votes">
    <div id="Vu118933">
    <a href="https://www.php.net/manual/vote-note.php?id=118933&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd118933">
    <a href="https://www.php.net/manual/vote-note.php?id=118933&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V118933" title="55% like this...">
    1
    </div>
  </div>
  <a href="function.flock.php.html#118933" class="name">
  <strong class="user"><em>emilchemical at gmail dot com</em></strong></a><a class="genanchor" href="function.flock.php.html#118933"> &para;</a><div class="date" title="2016-03-01 02:49"><strong>7 years ago</strong></div>
  <div class="text" id="Hcom118933">
<div class="phpcode"><code><span class="html">If you are interested in using file locking as indicator that your console app is running and you don't want to start it again:<br /><br /> if (!flock($fp, LOCK_EX | LOCK_NB, $wouldblock)) {<br />                if ($wouldblock) {<br />                    //Another process holds the lock!<br />               <br />                } else {<br />                    //Couldn't lock for another reason, e.g. no such file<br />             <br />                }<br />            } else {<br />                //Lock obtained<br /><br />                startJob();<br />            }<br />Please note that this is platform independent solution, but you have restrictions in PHP version (5.5.22 on Windows).<br />Also, some old file systems are not supported.</span></code></div>
  </div>
 </div>
  <div class="note" id="101701">  <div class="votes">
    <div id="Vu101701">
    <a href="https://www.php.net/manual/vote-note.php?id=101701&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd101701">
    <a href="https://www.php.net/manual/vote-note.php?id=101701&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V101701" title="55% like this...">
    3
    </div>
  </div>
  <a href="function.flock.php.html#101701" class="name">
  <strong class="user"><em>Evan Battaglia</em></strong></a><a class="genanchor" href="function.flock.php.html#101701"> &para;</a><div class="date" title="2011-01-05 05:13"><strong>13 years ago</strong></div>
  <div class="text" id="Hcom101701">
<div class="phpcode"><code><span class="html">LOCK_NB seems to be checked and works fine in Windows, too, in PHP 5.3.3.<br /><br />For instance, try concurrently running two instances of the following script (via the CLI). The second prints "Didn't quite get the lock..." as expected, whereas w/o the LOCK_NB flag, it just hangs.<br /><br /><span class="default">&lt;?php<br />$x </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"flocktest.txt"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">);<br />if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$x</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">|</span><span class="default">LOCK_NB</span><span class="keyword">)) {<br />    print </span><span class="string">"No problems, I got the lock, now I'm going to sit on it."</span><span class="keyword">;<br />    while (</span><span class="default">true</span><span class="keyword">)<br />        </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">5</span><span class="keyword">);<br />} else {<br />    print </span><span class="string">"Didn't quite get the lock. Quitting now. Good night."</span><span class="keyword">;<br />}<br /></span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$x</span><span class="keyword">);<br /></span><span class="default">?&gt;</span></span></code></div>
  </div>
 </div>
  <div class="note" id="115558">  <div class="votes">
    <div id="Vu115558">
    <a href="https://www.php.net/manual/vote-note.php?id=115558&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd115558">
    <a href="https://www.php.net/manual/vote-note.php?id=115558&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V115558" title="54% like this...">
    1
    </div>
  </div>
  <a href="function.flock.php.html#115558" class="name">
  <strong class="user"><em>sinus-php at sinpi dot net</em></strong></a><a class="genanchor" href="function.flock.php.html#115558"> &para;</a><div class="date" title="2014-08-15 02:01"><strong>9 years ago</strong></div>
  <div class="text" id="Hcom115558">
<div class="phpcode"><code><span class="html">"Assigning another value to handle argument in subsequent code will release the lock."<br />Note: this is also true for losing the handle's context completely (like returning from a function, in which the handle was a local variable).<br /><br /><span class="default">&lt;?php<br />touch</span><span class="keyword">(</span><span class="string">"testfile"</span><span class="keyword">);<br /><br />function </span><span class="default">mylock</span><span class="keyword">() {<br />  </span><span class="default">$F1 </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"testfile"</span><span class="keyword">,</span><span class="string">"r"</span><span class="keyword">);<br />  if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$F1</span><span class="keyword">,</span><span class="default">LOCK_EX</span><span class="keyword">|</span><span class="default">LOCK_NB</span><span class="keyword">)) echo </span><span class="string">"First lock OK\n"</span><span class="keyword">; else echo </span><span class="string">"First lock FAIL\n"</span><span class="keyword">;<br />  </span><span class="default">$F2 </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"testfile"</span><span class="keyword">,</span><span class="string">"r"</span><span class="keyword">);<br />  if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$F2</span><span class="keyword">,</span><span class="default">LOCK_EX</span><span class="keyword">|</span><span class="default">LOCK_NB</span><span class="keyword">)) echo </span><span class="string">"Second lock OK\n"</span><span class="keyword">; else echo </span><span class="string">"Second lock FAIL\n"</span><span class="keyword">;<br />}<br /><br /></span><span class="default">mylock</span><span class="keyword">();<br />echo </span><span class="string">"Function returned.\n"</span><span class="keyword">;<br /></span><span class="default">mylock</span><span class="keyword">();<br /><br /></span><span class="default">unlink</span><span class="keyword">(</span><span class="string">"testfile"</span><span class="keyword">);<br /></span><span class="default">?&gt;<br /></span><br />Prints out:<br /><br />First lock OK<br />Second lock FAIL<br />Function returned.<br />First lock OK<br />Second lock FAIL<br /><br />This will lock the testfile, then attempt to lock it again with a new file handle (obviously failing). Trying this again, though, results in proper locking again (and then failing again), because when exiting the function both handles are lost and automatically unlocked.</span></code></div>
  </div>
 </div>
  <div class="note" id="128609">  <div class="votes">
    <div id="Vu128609">
    <a href="https://www.php.net/manual/vote-note.php?id=128609&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd128609">
    <a href="https://www.php.net/manual/vote-note.php?id=128609&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V128609" title="100% like this...">
    2
    </div>
  </div>
  <a href="function.flock.php.html#128609" class="name">
  <strong class="user"><em>orkans at gmail dot com</em></strong></a><a class="genanchor" href="function.flock.php.html#128609"> &para;</a><div class="date" title="2023-06-13 02:06"><strong>8 months ago</strong></div>
  <div class="text" id="Hcom128609">
<div class="phpcode"><code><span class="html">Watch out for implied lock release!<br /><br /><span class="default">&lt;?php<br />flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_SH</span><span class="keyword">);<br /><br />if(!</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX </span><span class="keyword">| </span><span class="default">LOCK_NB</span><span class="keyword">)) {<br />    echo </span><span class="string">'Unable to obtain exclusive lock'</span><span class="keyword">;<br />}<br /><br /></span><span class="comment">// Now the LOCK_SH is gone too!<br /><br /></span><span class="default">?&gt;</span></span></code></div>
  </div>
 </div>
  <div class="note" id="129025">  <div class="votes">
    <div id="Vu129025">
    <a href="https://www.php.net/manual/vote-note.php?id=129025&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd129025">
    <a href="https://www.php.net/manual/vote-note.php?id=129025&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V129025" title="100% like this...">
    1
    </div>
  </div>
  <a href="function.flock.php.html#129025" class="name">
  <strong class="user"><em>andy at andyslife dot org</em></strong></a><a class="genanchor" href="function.flock.php.html#129025"> &para;</a><div class="date" title="2023-11-09 05:20"><strong>3 months ago</strong></div>
  <div class="text" id="Hcom129025">
<div class="phpcode"><code><span class="html">Important if using this to lock a class into a single instance (long duration processes). The file handle needs to be a class wide variable like $this-&gt;singleinstance. Not local to the __construct function like $localvariable. The reason is the local variable is gone after __construct is called so the lock lasts for only millisconds and not for the full duration of class running in memory.</span></code></div>
  </div>
 </div>
  <div class="note" id="121196">  <div class="votes">
    <div id="Vu121196">
    <a href="https://www.php.net/manual/vote-note.php?id=121196&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd121196">
    <a href="https://www.php.net/manual/vote-note.php?id=121196&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V121196" title="100% like this...">
    2
    </div>
  </div>
  <a href="function.flock.php.html#121196" class="name">
  <strong class="user"><em>peripeltus at gmail dot com</em></strong></a><a class="genanchor" href="function.flock.php.html#121196"> &para;</a><div class="date" title="2017-06-07 01:40"><strong>6 years ago</strong></div>
  <div class="text" id="Hcom121196">
<div class="phpcode"><code><span class="html">Relying on flock for synchronise things is risky, consider using extensions like SYNC or pthreads instead.</span></code></div>
  </div>
 </div>
  <div class="note" id="116782">  <div class="votes">
    <div id="Vu116782">
    <a href="https://www.php.net/manual/vote-note.php?id=116782&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd116782">
    <a href="https://www.php.net/manual/vote-note.php?id=116782&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V116782" title="100% like this...">
    2
    </div>
  </div>
  <a href="function.flock.php.html#116782" class="name">
  <strong class="user"><em>ravenswd at gmail dot com</em></strong></a><a class="genanchor" href="function.flock.php.html#116782"> &para;</a><div class="date" title="2015-02-27 05:32"><strong>8 years ago</strong></div>
  <div class="text" id="Hcom116782">
<div class="phpcode"><code><span class="html">Note that Example #1 contains a bug: ftruncate() does *not* re-set the file pointer to the beginning of the file. You need to execute a call to rewind() afterward. I realize that the ftruncate page does mention this, but if anybody copies the example above (as I did), their program will not work correctly unless they fix this.</span></code></div>
  </div>
 </div>
  <div class="note" id="79668">  <div class="votes">
    <div id="Vu79668">
    <a href="https://www.php.net/manual/vote-note.php?id=79668&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd79668">
    <a href="https://www.php.net/manual/vote-note.php?id=79668&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V79668" title="100% like this...">
    2
    </div>
  </div>
  <a href="function.flock.php.html#79668" class="name">
  <strong class="user"><em>candide at idees-et-solutions dot fr</em></strong></a><a class="genanchor" href="function.flock.php.html#79668"> &para;</a><div class="date" title="2007-12-07 03:48"><strong>16 years ago</strong></div>
  <div class="text" id="Hcom79668">
<div class="phpcode"><code><span class="html">Just a comment about the last method to lock files using filemtime().<br />What if   filemtime($fp[1]) == $fp[3]   because somebody modified the file less than 1s after the value of $fp[3] was picked up?<br />Then this modification will be lost...? <br /><br />This system to lock files is made to prevent problems when two modifications are so close that they can interfere, so the case "less than 1s" will often happen?<br /><br />However, lose some modifications is better than spoil all the file...</span></code></div>
  </div>
 </div>
  <div class="note" id="93400">  <div class="votes">
    <div id="Vu93400">
    <a href="https://www.php.net/manual/vote-note.php?id=93400&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd93400">
    <a href="https://www.php.net/manual/vote-note.php?id=93400&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V93400" title="45% like this...">
    -1
    </div>
  </div>
  <a href="function.flock.php.html#93400" class="name">
  <strong class="user"><em>daniel AT brightbyte DOT de</em></strong></a><a class="genanchor" href="function.flock.php.html#93400"> &para;</a><div class="date" title="2009-09-08 12:49"><strong>14 years ago</strong></div>
  <div class="text" id="Hcom93400">
<div class="phpcode"><code><span class="html">flock on Solaris is slightly strange: it will fail if you try to get an exclusive lock on a file not opened for writing. That is, for reading files, you MUST use a shared lock. From the Solaris man page for flock:<br /><br />"Read permission is required on a file to obtain a shared lock, and write  permission is required to obtain an exclusive lock."<br /><br />In contrast, this is from the Linux man page for flock:<br /><br />"The mode used to open the file doesn’t matter to flock."<br /><br />So, beware...</span></code></div>
  </div>
 </div>
  <div class="note" id="114928">  <div class="votes">
    <div id="Vu114928">
    <a href="https://www.php.net/manual/vote-note.php?id=114928&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd114928">
    <a href="https://www.php.net/manual/vote-note.php?id=114928&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V114928" title="42% like this...">
    -1
    </div>
  </div>
  <a href="function.flock.php.html#114928" class="name">
  <strong class="user"><em>tom dot vom dot berg at online dot de</em></strong></a><a class="genanchor" href="function.flock.php.html#114928"> &para;</a><div class="date" title="2014-04-28 06:46"><strong>9 years ago</strong></div>
  <div class="text" id="Hcom114928">
<div class="phpcode"><code><span class="html">if you are used to reply with qualified error messages by using "track_errors = 1" and $php_errormsg,  flock() will nark you, if you use LOCK_NB .<br /><br />If flock() fails due to LOCK_NB $php_errormsg will not be created and filled with an error message like 'could not lock file, file already locked'.<br /><br />You can use some little workaround which does also on WIN:<br /><br />#---------------------------------<br />GLOBAL $MYERRORMSG;<br /><br />function some_file_operations($filename)<br />{<br />    GLOBAL $MYERRORMSG;<br /><br />    # ...<br />    # ...<br /><br />    if (! @flock($fh, LOCK_SH | LOCK_NB, $wb))<br />       {<br />        if (!isset($php_errormsg)) $php_errormsg = 'could not lock file, file already locked';<br />        $MYERRORMSG = $php_errormsg;<br />        return false;<br />    }    <br />}<br />#--------------------------------<br /><br />In case of fail $MYERRORMSG now will hold a qualified error message</span></code></div>
  </div>
 </div>
  <div class="note" id="24100">  <div class="votes">
    <div id="Vu24100">
    <a href="https://www.php.net/manual/vote-note.php?id=24100&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd24100">
    <a href="https://www.php.net/manual/vote-note.php?id=24100&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V24100" title="38% like this...">
    -3
    </div>
  </div>
  <a href="function.flock.php.html#24100" class="name">
  <strong class="user"><em>geoff at message dot hu</em></strong></a><a class="genanchor" href="function.flock.php.html#24100"> &para;</a><div class="date" title="2002-08-06 01:10"><strong>21 years ago</strong></div>
  <div class="text" id="Hcom24100">
<div class="phpcode"><code><span class="html">You should lock the file _before_ opening it, and unlock _after_ closing it. Othervise an another process might be able to access the file between the lock/unlock and the open/close operation.</span></code></div>
  </div>
 </div>
  <div class="note" id="111443">  <div class="votes">
    <div id="Vu111443">
    <a href="https://www.php.net/manual/vote-note.php?id=111443&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd111443">
    <a href="https://www.php.net/manual/vote-note.php?id=111443&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V111443" title="33% like this...">
    -3
    </div>
  </div>
  <a href="function.flock.php.html#111443" class="name">
  <strong class="user"><em>steven at aubergine-it dot nl</em></strong></a><a class="genanchor" href="function.flock.php.html#111443"> &para;</a><div class="date" title="2013-02-20 03:14"><strong>10 years ago</strong></div>
  <div class="text" id="Hcom111443">
<div class="phpcode"><code><span class="html">You cannot combine gzopen with flock; so:<br /><br /><span class="default">&lt;?php<br />$f </span><span class="keyword">= </span><span class="default">gzopen</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">,</span><span class="string">'w'</span><span class="keyword">);<br /></span><span class="default">$o </span><span class="keyword">= </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$f</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">);<br /></span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$o</span><span class="keyword">);<br /></span><span class="default">flush</span><span class="keyword">();<br /></span><span class="default">?&gt;<br /></span><br />Gives:<br /><br />boolean false</span></code></div>
  </div>
 </div>
  <div class="note" id="74155">  <div class="votes">
    <div id="Vu74155">
    <a href="https://www.php.net/manual/vote-note.php?id=74155&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd74155">
    <a href="https://www.php.net/manual/vote-note.php?id=74155&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V74155" title="33% like this...">
    -3
    </div>
  </div>
  <a href="function.flock.php.html#74155" class="name">
  <strong class="user"><em>Will Reiher</em></strong></a><a class="genanchor" href="function.flock.php.html#74155"> &para;</a><div class="date" title="2007-03-27 04:52"><strong>16 years ago</strong></div>
  <div class="text" id="Hcom74155">
<div class="phpcode"><code><span class="html">I've been testing a few custom file access functions but I always liked the simplicity of file_get_contents(). Of course it doesn't seem to respect any file locks created with flock(). I created the function below to wrap around file_get_contents() so it can support locked files. It's an odd way of doing it but it works for me.<br /><br /><span class="default">&lt;?php<br /></span><span class="keyword">function </span><span class="default">flock_get_contents</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">){<br /><br />    </span><span class="default">$return </span><span class="keyword">= </span><span class="default">FALSE</span><span class="keyword">;<br /><br />    if(</span><span class="default">is_string</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">) &amp;&amp; !empty(</span><span class="default">$filename</span><span class="keyword">)){<br />        if(</span><span class="default">is_readable</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">)){<br />            if(</span><span class="default">$handle </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">, </span><span class="string">'r'</span><span class="keyword">)){<br />                while(!</span><span class="default">$return</span><span class="keyword">){<br />                    if(</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">, </span><span class="default">LOCK_SH</span><span class="keyword">)){<br />                        if(</span><span class="default">$return </span><span class="keyword">= </span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">)){<br />                            </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">, </span><span class="default">LOCK_UN</span><span class="keyword">);<br />                        }<br />                    }<br />                }<br />                </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">);<br />            }<br />        }<br />    }<br />    <br />    return </span><span class="default">$return</span><span class="keyword">;<br />}<br /></span><span class="default">?&gt;</span></span></code></div>
  </div>
 </div>
  <div class="note" id="99931">  <div class="votes">
    <div id="Vu99931">
    <a href="https://www.php.net/manual/vote-note.php?id=99931&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd99931">
    <a href="https://www.php.net/manual/vote-note.php?id=99931&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V99931" title="30% like this...">
    -5
    </div>
  </div>
  <a href="function.flock.php.html#99931" class="name">
  <strong class="user"><em>mirco dot babin at gmail dot com</em></strong></a><a class="genanchor" href="function.flock.php.html#99931"> &para;</a><div class="date" title="2010-09-15 10:10"><strong>13 years ago</strong></div>
  <div class="text" id="Hcom99931">
<div class="phpcode"><code><span class="html">Because:<br />1) flock() is not safe if multiple php sessions are simultaneously locking.<br />2) fopen( , 'a') is not safe if multiple php sessions are simultaneously appending.<br />3) usleep and sleep are known for having problems.<br /><br />I wrote the Weblog function, it's purpose is to append a line to logging. This function handles the concurrency as follows:<br />- Try to create a lockfile named: $directory . date('Ymd') . $logfile . 1 . lock<br />- If this fails, try to create lockfile named: $directory . date('Ymd') . $logfile . 2 . lock<br />- etc. After 100 tries return false.<br /><br />- When the lockfile is acquired the file named: $directory.date('Ymd').$logfile.1 (or .2 or .3 or .25) is opened or created.<br />- If created the a "extended log file" header is written.<br />- Write out the line.<br />- Close the flie and if created set the correct access rights. (I had some problems creating files on a webserver, I did not see them when I opened a FTP session to the webdirectory. The chmod did the trick for me).<br /><br />- Remove the lockfile.<br /><br />There is only one drawback, multiple logfiles are created.<br />e.g. (executed on 15 september 2010)<br />    Weblog('./' , 'visit', 'Somebody requested the index page');<br />Could lead to 100 files, depending how many concurrent php sessions are simultaneously trying to append a logline:<br />./20100915visit.1<br />./20100915visit.2 <br />./20100915visit.3<br />./20100915visit.4<br />...<br />./20100915visit.100<br /><br />This function is donated to the public domain. Maybe you can give me some credit by leaving in the author comment, but it is not required. You may modify this as you wish.<br />(This function was inspired by the function m_lock_file presented by Kuzma dot Deretuke at gmail dot com)<br /><br /><span class="default">&lt;?php<br /></span><span class="keyword">function </span><span class="default">Weblog</span><span class="keyword">(</span><span class="default">$directory</span><span class="keyword">, </span><span class="default">$logfile</span><span class="keyword">, </span><span class="default">$message</span><span class="keyword">)<br />{<br />    </span><span class="comment">// Created 15 september 2010: Mirco Babin<br />    </span><span class="default">$curtime </span><span class="keyword">= </span><span class="default">time</span><span class="keyword">();<br />    </span><span class="default">$logfile </span><span class="keyword">= </span><span class="default">date</span><span class="keyword">(</span><span class="string">'Ymd'</span><span class="keyword">,</span><span class="default">$curtime</span><span class="keyword">) . </span><span class="default">$logfile</span><span class="keyword">;<br /><br />    if (!isset(</span><span class="default">$directory</span><span class="keyword">) || </span><span class="default">$directory </span><span class="keyword">=== </span><span class="default">false</span><span class="keyword">)<br />        </span><span class="default">$directory </span><span class="keyword">= </span><span class="string">'./'</span><span class="keyword">;<br />    if (</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$directory</span><span class="keyword">,-</span><span class="default">1</span><span class="keyword">) !== </span><span class="string">'/'</span><span class="keyword">)<br />        </span><span class="default">$directory </span><span class="keyword">= </span><span class="default">$directory </span><span class="keyword">. </span><span class="string">'/'</span><span class="keyword">;<br />        <br />    </span><span class="default">$count </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">;<br />    while(</span><span class="default">1</span><span class="keyword">)<br />    {<br />        </span><span class="default">$logfilename </span><span class="keyword">= </span><span class="default">$directory </span><span class="keyword">. </span><span class="default">$logfile </span><span class="keyword">. </span><span class="string">'.' </span><span class="keyword">. </span><span class="default">$count</span><span class="keyword">;<br />        <br />        </span><span class="default">$lockfile </span><span class="keyword">= </span><span class="default">$logfilename </span><span class="keyword">. </span><span class="string">'.lock'</span><span class="keyword">;<br />        </span><span class="default">$lockhandle </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />        if (!</span><span class="default">file_exists</span><span class="keyword">(</span><span class="default">$lockfile</span><span class="keyword">) || @</span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$lockfile</span><span class="keyword">)) <br />            </span><span class="default">$lockhandle </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$lockfile</span><span class="keyword">, </span><span class="string">'xb'</span><span class="keyword">);<br />        if (</span><span class="default">$lockhandle </span><span class="keyword">!== </span><span class="default">false</span><span class="keyword">) break;<br /><br />        </span><span class="default">$count</span><span class="keyword">++;<br />        if (</span><span class="default">$count </span><span class="keyword">&gt; </span><span class="default">100</span><span class="keyword">) return </span><span class="default">false</span><span class="keyword">;<br />    }<br />    <br />    if (</span><span class="default">file_exists</span><span class="keyword">(</span><span class="default">$logfilename</span><span class="keyword">))<br />        {<br />            </span><span class="default">$created   </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />            </span><span class="default">$loghandle </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$logfilename</span><span class="keyword">, </span><span class="string">'ab'</span><span class="keyword">);<br />        }<br />    else<br />        {<br />            </span><span class="default">$loghandle </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$logfilename</span><span class="keyword">, </span><span class="string">'xb'</span><span class="keyword">);<br />            if (</span><span class="default">$loghandle </span><span class="keyword">!== </span><span class="default">false</span><span class="keyword">)<br />                {<br />                    </span><span class="default">$created </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />                    <br />                    </span><span class="default">$str </span><span class="keyword">= </span><span class="string">'#version: 1.0' </span><span class="keyword">. </span><span class="string">"\r\n" </span><span class="keyword">.<br />                           </span><span class="string">'#Fields: date time c-ip x-msg' </span><span class="keyword">. </span><span class="string">"\r\n"</span><span class="keyword">;<br />                    </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$loghandle</span><span class="keyword">,</span><span class="default">$str</span><span class="keyword">);<br />                }<br />            }<br />    <br />    if (</span><span class="default">$loghandle </span><span class="keyword">!== </span><span class="default">false</span><span class="keyword">)<br />        {<br />            </span><span class="default">$str </span><span class="keyword">= </span><span class="default">date</span><span class="keyword">(</span><span class="string">'Y-m-d'</span><span class="keyword">,</span><span class="default">$curtime</span><span class="keyword">) . </span><span class="string">"\t" </span><span class="keyword">. <br />                   </span><span class="default">date</span><span class="keyword">(</span><span class="string">'H:i:s'</span><span class="keyword">, </span><span class="default">$curtime</span><span class="keyword">) .  </span><span class="string">"\t" </span><span class="keyword">.<br />                   (isset(</span><span class="default">$_SERVER</span><span class="keyword">[</span><span class="string">'REMOTE_ADDR'</span><span class="keyword">]) ? </span><span class="default">$_SERVER</span><span class="keyword">[</span><span class="string">'REMOTE_ADDR'</span><span class="keyword">] : </span><span class="string">'-'</span><span class="keyword">) . </span><span class="string">"\t" </span><span class="keyword">.<br />                   </span><span class="string">'"' </span><span class="keyword">. </span><span class="default">str_replace</span><span class="keyword">(</span><span class="string">'"'</span><span class="keyword">, </span><span class="string">'""'</span><span class="keyword">, </span><span class="default">$message</span><span class="keyword">) . </span><span class="string">'"' </span><span class="keyword">. </span><span class="string">"\r\n"</span><span class="keyword">;<br />            </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$loghandle</span><span class="keyword">,</span><span class="default">$str</span><span class="keyword">);<br />            <br />            </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$loghandle</span><span class="keyword">);<br />            <br />            if (</span><span class="default">$created</span><span class="keyword">) </span><span class="default">chmod</span><span class="keyword">(</span><span class="default">$logfilename</span><span class="keyword">,</span><span class="default">0644</span><span class="keyword">); </span><span class="comment">// Read and write for owner, read for everybody else<br />            <br />            </span><span class="default">$result </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />        }<br />    else<br />        {<br />            </span><span class="default">$result </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />        }<br />    <br />    </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$lockhandle</span><span class="keyword">);<br />    @</span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$lockfile</span><span class="keyword">);<br /><br />    return </span><span class="default">$result</span><span class="keyword">;<br />}<br /></span><span class="default">?&gt;</span></span></code></div>
  </div>
 </div>
  <div class="note" id="114036">  <div class="votes">
    <div id="Vu114036">
    <a href="https://www.php.net/manual/vote-note.php?id=114036&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd114036">
    <a href="https://www.php.net/manual/vote-note.php?id=114036&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V114036" title="28% like this...">
    -3
    </div>
  </div>
  <a href="function.flock.php.html#114036" class="name">
  <strong class="user"><em>enyby at yandex dot ru</em></strong></a><a class="genanchor" href="function.flock.php.html#114036"> &para;</a><div class="date" title="2014-01-04 08:36"><strong>10 years ago</strong></div>
  <div class="text" id="Hcom114036">
<div class="phpcode"><code><span class="html">Use rename or unlink on handled file breaked LOCK_EX flock on handle (Linux only).<br /><br />Example:<br /><br />$handle = fopen($lockFile, 'c');<br />var_dump(flock($handle, LOCK_EX | LOCK_NB)); // false because flock use other php process<br />rename($lockFile, $lockFile.'.old'); // or unlink<br />var_dump(flock($handle, LOCK_EX | LOCK_NB)); // always true (!!!)</span></code></div>
  </div>
 </div>
  <div class="note" id="39466">  <div class="votes">
    <div id="Vu39466">
    <a href="https://www.php.net/manual/vote-note.php?id=39466&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd39466">
    <a href="https://www.php.net/manual/vote-note.php?id=39466&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V39466" title="30% like this...">
    -4
    </div>
  </div>
  <a href="function.flock.php.html#39466" class="name">
  <strong class="user"><em>Glip</em></strong></a><a class="genanchor" href="function.flock.php.html#39466"> &para;</a><div class="date" title="2004-01-29 10:39"><strong>20 years ago</strong></div>
  <div class="text" id="Hcom39466">
<div class="phpcode"><code><span class="html">If you don't want use secondary lock file while truncating, try this:<br /><br /><span class="default">&lt;?php<br /><br />$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"/tmp/lock.txt"</span><span class="keyword">, </span><span class="string">"a+"</span><span class="keyword">);<br /><br />if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">)) { </span><span class="comment">// do an exclusive lock<br />   </span><span class="default">ftruncate</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />   </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">"Write something here\n"</span><span class="keyword">);<br />   </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_UN</span><span class="keyword">); </span><span class="comment">// release the lock<br /></span><span class="keyword">} else {<br />   echo </span><span class="string">"Couldn't lock the file !"</span><span class="keyword">;<br />}<br /><br /></span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br /><br /></span><span class="default">?&gt;</span></span></code></div>
  </div>
 </div>
  <div class="note" id="105879">  <div class="votes">
    <div id="Vu105879">
    <a href="https://www.php.net/manual/vote-note.php?id=105879&amp;page=function.flock&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd105879">
    <a href="https://www.php.net/manual/vote-note.php?id=105879&amp;page=function.flock&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V105879" title="13% like this...">
    -11
    </div>
  </div>
  <a href="function.flock.php.html#105879" class="name">
  <strong class="user"><em>mdessaintes at gmail dot com</em></strong></a><a class="genanchor" href="function.flock.php.html#105879"> &para;</a><div class="date" title="2011-09-22 08:44"><strong>12 years ago</strong></div>
  <div class="text" id="Hcom105879">
<div class="phpcode"><code><span class="html">I just spend a long time to understand why write function returns me "0", on a basic file opening and then writing.<br /><br />I discovered that if you use LOCK_SH and then you write something, that will not work :<br /><br /><span class="default">&lt;?php<br />$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'file.txt'</span><span class="keyword">, </span><span class="string">'a'</span><span class="keyword">);<br /><br /></span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">,</span><span class="default">LOCK_SH</span><span class="keyword">);<br /><br /></span><span class="default">$written </span><span class="keyword">= </span><span class="default">fputs</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">'data'</span><span class="keyword">);<br /><br /></span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$written</span><span class="keyword">); </span><span class="comment">// 0 and file is not changed<br /><br /></span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br /></span><span class="default">?&gt;</span></span></code></div>
  </div>
 </div></div>
<div class="foot"><a href="https://www.php.net/manual/add-note.php?sect=function.flock&amp;redirect=https://www.php.net/manual/ru/function.flock.php">＋<small>add a note</small></a></div>
</section>    </section><!-- layout-content -->
        <aside class='layout-menu'>

        <ul class='parent-menu-list'>
                                    <li>
                <a href="ref.filesystem.php.html">Функции файловой системы</a>

                                    <ul class='child-menu-list'>

                                                <li class="">
                            <a href="function.basename.php.html" title="basename">basename</a>
                        </li>
                                                <li class="">
                            <a href="function.chgrp.php.html" title="chgrp">chgrp</a>
                        </li>
                                                <li class="">
                            <a href="function.chmod.php.html" title="chmod">chmod</a>
                        </li>
                                                <li class="">
                            <a href="function.chown.php.html" title="chown">chown</a>
                        </li>
                                                <li class="">
                            <a href="function.clearstatcache.php.html" title="clearstatcache">clearstatcache</a>
                        </li>
                                                <li class="">
                            <a href="function.copy.php.html" title="copy">copy</a>
                        </li>
                                                <li class="">
                            <a href="function.delete.php.html" title="delete">delete</a>
                        </li>
                                                <li class="">
                            <a href="function.dirname.php.html" title="dirname">dirname</a>
                        </li>
                                                <li class="">
                            <a href="function.disk-free-space.php.html" title="disk_&#8203;free_&#8203;space">disk_&#8203;free_&#8203;space</a>
                        </li>
                                                <li class="">
                            <a href="function.disk-total-space.php.html" title="disk_&#8203;total_&#8203;space">disk_&#8203;total_&#8203;space</a>
                        </li>
                                                <li class="">
                            <a href="function.diskfreespace.php.html" title="diskfreespace">diskfreespace</a>
                        </li>
                                                <li class="">
                            <a href="function.fclose.php.html" title="fclose">fclose</a>
                        </li>
                                                <li class="">
                            <a href="function.fdatasync.php.html" title="fdatasync">fdatasync</a>
                        </li>
                                                <li class="">
                            <a href="function.feof.php.html" title="feof">feof</a>
                        </li>
                                                <li class="">
                            <a href="function.fflush.php.html" title="fflush">fflush</a>
                        </li>
                                                <li class="">
                            <a href="function.fgetc.php.html" title="fgetc">fgetc</a>
                        </li>
                                                <li class="">
                            <a href="function.fgetcsv.php.html" title="fgetcsv">fgetcsv</a>
                        </li>
                                                <li class="">
                            <a href="function.fgets.php.html" title="fgets">fgets</a>
                        </li>
                                                <li class="">
                            <a href="function.fgetss.php.html" title="fgetss">fgetss</a>
                        </li>
                                                <li class="">
                            <a href="function.file-exists.php.html" title="file_&#8203;exists">file_&#8203;exists</a>
                        </li>
                                                <li class="">
                            <a href="function.file-get-contents.php.html" title="file_&#8203;get_&#8203;contents">file_&#8203;get_&#8203;contents</a>
                        </li>
                                                <li class="">
                            <a href="function.file-put-contents.php.html" title="file_&#8203;put_&#8203;contents">file_&#8203;put_&#8203;contents</a>
                        </li>
                                                <li class="">
                            <a href="function.file.php.html" title="file">file</a>
                        </li>
                                                <li class="">
                            <a href="function.fileatime.php.html" title="fileatime">fileatime</a>
                        </li>
                                                <li class="">
                            <a href="function.filectime.php.html" title="filectime">filectime</a>
                        </li>
                                                <li class="">
                            <a href="function.filegroup.php.html" title="filegroup">filegroup</a>
                        </li>
                                                <li class="">
                            <a href="function.fileinode.php.html" title="fileinode">fileinode</a>
                        </li>
                                                <li class="">
                            <a href="function.filemtime.php.html" title="filemtime">filemtime</a>
                        </li>
                                                <li class="">
                            <a href="function.fileowner.php.html" title="fileowner">fileowner</a>
                        </li>
                                                <li class="">
                            <a href="function.fileperms.php.html" title="fileperms">fileperms</a>
                        </li>
                                                <li class="">
                            <a href="function.filesize.php.html" title="filesize">filesize</a>
                        </li>
                                                <li class="">
                            <a href="function.filetype.php.html" title="filetype">filetype</a>
                        </li>
                                                <li class="current">
                            <a href="function.flock.php.html" title="flock">flock</a>
                        </li>
                                                <li class="">
                            <a href="function.fnmatch.php.html" title="fnmatch">fnmatch</a>
                        </li>
                                                <li class="">
                            <a href="function.fopen.php.html" title="fopen">fopen</a>
                        </li>
                                                <li class="">
                            <a href="function.fpassthru.php.html" title="fpassthru">fpassthru</a>
                        </li>
                                                <li class="">
                            <a href="function.fputcsv.php.html" title="fputcsv">fputcsv</a>
                        </li>
                                                <li class="">
                            <a href="function.fputs.php.html" title="fputs">fputs</a>
                        </li>
                                                <li class="">
                            <a href="function.fread.php.html" title="fread">fread</a>
                        </li>
                                                <li class="">
                            <a href="function.fscanf.php.html" title="fscanf">fscanf</a>
                        </li>
                                                <li class="">
                            <a href="function.fseek.php.html" title="fseek">fseek</a>
                        </li>
                                                <li class="">
                            <a href="function.fstat.php.html" title="fstat">fstat</a>
                        </li>
                                                <li class="">
                            <a href="function.fsync.php.html" title="fsync">fsync</a>
                        </li>
                                                <li class="">
                            <a href="function.ftell.php.html" title="ftell">ftell</a>
                        </li>
                                                <li class="">
                            <a href="function.ftruncate.php.html" title="ftruncate">ftruncate</a>
                        </li>
                                                <li class="">
                            <a href="function.fwrite.php.html" title="fwrite">fwrite</a>
                        </li>
                                                <li class="">
                            <a href="function.glob.php.html" title="glob">glob</a>
                        </li>
                                                <li class="">
                            <a href="function.is-dir.php.html" title="is_&#8203;dir">is_&#8203;dir</a>
                        </li>
                                                <li class="">
                            <a href="function.is-executable.php.html" title="is_&#8203;executable">is_&#8203;executable</a>
                        </li>
                                                <li class="">
                            <a href="function.is-file.php.html" title="is_&#8203;file">is_&#8203;file</a>
                        </li>
                                                <li class="">
                            <a href="function.is-link.php.html" title="is_&#8203;link">is_&#8203;link</a>
                        </li>
                                                <li class="">
                            <a href="function.is-readable.php.html" title="is_&#8203;readable">is_&#8203;readable</a>
                        </li>
                                                <li class="">
                            <a href="function.is-uploaded-file.php.html" title="is_&#8203;uploaded_&#8203;file">is_&#8203;uploaded_&#8203;file</a>
                        </li>
                                                <li class="">
                            <a href="function.is-writable.php.html" title="is_&#8203;writable">is_&#8203;writable</a>
                        </li>
                                                <li class="">
                            <a href="function.is-writeable.php.html" title="is_&#8203;writeable">is_&#8203;writeable</a>
                        </li>
                                                <li class="">
                            <a href="function.lchgrp.php.html" title="lchgrp">lchgrp</a>
                        </li>
                                                <li class="">
                            <a href="function.lchown.php.html" title="lchown">lchown</a>
                        </li>
                                                <li class="">
                            <a href="function.link.php.html" title="link">link</a>
                        </li>
                                                <li class="">
                            <a href="function.linkinfo.php.html" title="linkinfo">linkinfo</a>
                        </li>
                                                <li class="">
                            <a href="function.lstat.php.html" title="lstat">lstat</a>
                        </li>
                                                <li class="">
                            <a href="function.mkdir.php.html" title="mkdir">mkdir</a>
                        </li>
                                                <li class="">
                            <a href="function.move-uploaded-file.php.html" title="move_&#8203;uploaded_&#8203;file">move_&#8203;uploaded_&#8203;file</a>
                        </li>
                                                <li class="">
                            <a href="function.parse-ini-file.php.html" title="parse_&#8203;ini_&#8203;file">parse_&#8203;ini_&#8203;file</a>
                        </li>
                                                <li class="">
                            <a href="function.parse-ini-string.php.html" title="parse_&#8203;ini_&#8203;string">parse_&#8203;ini_&#8203;string</a>
                        </li>
                                                <li class="">
                            <a href="function.pathinfo.php.html" title="pathinfo">pathinfo</a>
                        </li>
                                                <li class="">
                            <a href="function.pclose.php.html" title="pclose">pclose</a>
                        </li>
                                                <li class="">
                            <a href="function.popen.php.html" title="popen">popen</a>
                        </li>
                                                <li class="">
                            <a href="function.readfile.php.html" title="readfile">readfile</a>
                        </li>
                                                <li class="">
                            <a href="function.readlink.php.html" title="readlink">readlink</a>
                        </li>
                                                <li class="">
                            <a href="function.realpath-cache-get.php.html" title="realpath_&#8203;cache_&#8203;get">realpath_&#8203;cache_&#8203;get</a>
                        </li>
                                                <li class="">
                            <a href="function.realpath-cache-size.php.html" title="realpath_&#8203;cache_&#8203;size">realpath_&#8203;cache_&#8203;size</a>
                        </li>
                                                <li class="">
                            <a href="function.realpath.php.html" title="realpath">realpath</a>
                        </li>
                                                <li class="">
                            <a href="function.rename.php.html" title="rename">rename</a>
                        </li>
                                                <li class="">
                            <a href="function.rewind.php.html" title="rewind">rewind</a>
                        </li>
                                                <li class="">
                            <a href="function.rmdir.php.html" title="rmdir">rmdir</a>
                        </li>
                                                <li class="">
                            <a href="function.set-file-buffer.php.html" title="set_&#8203;file_&#8203;buffer">set_&#8203;file_&#8203;buffer</a>
                        </li>
                                                <li class="">
                            <a href="function.stat.php.html" title="stat">stat</a>
                        </li>
                                                <li class="">
                            <a href="function.symlink.php.html" title="symlink">symlink</a>
                        </li>
                                                <li class="">
                            <a href="function.tempnam.php.html" title="tempnam">tempnam</a>
                        </li>
                                                <li class="">
                            <a href="function.tmpfile.php.html" title="tmpfile">tmpfile</a>
                        </li>
                                                <li class="">
                            <a href="function.touch.php.html" title="touch">touch</a>
                        </li>
                                                <li class="">
                            <a href="function.umask.php.html" title="umask">umask</a>
                        </li>
                                                <li class="">
                            <a href="function.unlink.php.html" title="unlink">unlink</a>
                        </li>
                        
                    </ul>
                
            </li>
                        
                    </ul>
    </aside>


  </div><!-- layout -->

  <footer>
    <div class="container footer-content">
      <div class="row-fluid">
      <ul class="footmenu">
        <li><a href="https://www.php.net/copyright.php">Copyright &copy; 2001-2024 The PHP Group</a></li>
        <li><a href="https://www.php.net/my.php">My PHP.net</a></li>
        <li><a href="https://www.php.net/contact.php">Contact</a></li>
        <li><a href="https://www.php.net/sites.php">Other PHP.net sites</a></li>
        <li><a href="https://www.php.net/privacy.php">Privacy policy</a></li>
      </ul>
      </div>
    </div>
  </footer>

    
 <!-- External and third party libraries. -->
 <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="../../cached.php%3Ft=1657730402&amp;f=%252Fjs%252Fext%252Fhogan-3.0.2.min.js"></script>
<script src="../../cached.php%3Ft=1421837618&amp;f=%252Fjs%252Fext%252Ftypeahead.min.js"></script>
<script src="../../cached.php%3Ft=1657876202&amp;f=%252Fjs%252Fext%252Fmousetrap.min.js"></script>
<script src="../../cached.php%3Ft=1657730402&amp;f=%252Fjs%252Fext%252Fjquery.scrollTo.min.js"></script>
<script src="../../cached.php%3Ft=1701958202&amp;f=%252Fjs%252Fsearch.js"></script>
<script src="../../cached.php%3Ft=1701958202&amp;f=%252Fjs%252Fcommon.js"></script>

<a id="toTop" href="javascript:;"><span id="toTopHover"></span><img width="40" height="40" alt="To Top" src="../../images/to-top@2x.png"></a>

</body>
</html>
