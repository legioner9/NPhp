<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ru">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>PHP: Безопасность файловой системы - Manual </title>

 <link rel="icon" type="image/svg+xml" sizes="any" href="../../favicon.svg%3Fv=2">
 <link rel="icon" type="image/png" sizes="196x196" href="../../favicon-196x196.png%3Fv=2">
 <link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png%3Fv=2">
 <link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png%3Fv=2">
 <link rel="shortcut icon" href="../../favicon.ico%3Fv=2">

 <link rel="search" type="application/opensearchdescription+xml" href="http://php.net/phpnetimprovedsearch.src" title="Add PHP.net search">
 <link rel="alternate" type="application/atom+xml" href="https://www.php.net/releases/feed.php" title="PHP Release feed">
 <link rel="alternate" type="application/atom+xml" href="https://www.php.net/feed.atom" title="PHP: Hypertext Preprocessor">

 <link rel="canonical" href="security.filesystem.php.html">
 <link rel="shorturl" href="security.filesystem.php.html">
 <link rel="alternate" href="security.filesystem.php.html" hreflang="x-default">

 <link rel="contents" href="index.php.html">
 <link rel="index" href="security.php.html">
 <link rel="prev" href="security.sessions.php.html">
 <link rel="next" href="security.filesystem.nullbytes.php.html">

 <link rel="alternate" href="https://www.php.net/manual/en/security.filesystem.php" hreflang="en">
 <link rel="alternate" href="https://www.php.net/manual/de/security.filesystem.php" hreflang="de">
 <link rel="alternate" href="https://www.php.net/manual/es/security.filesystem.php" hreflang="es">
 <link rel="alternate" href="https://www.php.net/manual/fr/security.filesystem.php" hreflang="fr">
 <link rel="alternate" href="https://www.php.net/manual/it/security.filesystem.php" hreflang="it">
 <link rel="alternate" href="https://www.php.net/manual/ja/security.filesystem.php" hreflang="ja">
 <link rel="alternate" href="https://www.php.net/manual/pt_BR/security.filesystem.php" hreflang="pt_BR">
 <link rel="alternate" href="security.filesystem.php.html" hreflang="ru">
 <link rel="alternate" href="https://www.php.net/manual/tr/security.filesystem.php" hreflang="tr">
 <link rel="alternate" href="https://www.php.net/manual/zh/security.filesystem.php" hreflang="zh">

<link rel="stylesheet" type="text/css" href="../../cached.php%3Ft=1689765002&amp;f=%252Ffonts%252FFira%252Ffira.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cached.php%3Ft=1700771401&amp;f=%252Ffonts%252FFont-Awesome%252Fcss%252Ffontello.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cached.php%3Ft=1705413607&amp;f=%252Fstyles%252Ftheme-base.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cached.php%3Ft=1701958202&amp;f=%252Fstyles%252Ftheme-medium.css" media="screen">

 <base href="">


</head>
<body class="docs ">

<nav id="head-nav" class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <a href="https://www.php.net/" class="brand"><img src="../../images/logos/php-logo.svg" width="48" height="24" alt="php"></a>
    <div id="mainmenu-toggle-overlay"></div>
    <input type="checkbox" id="mainmenu-toggle">
    <ul class="nav">
      <li class=""><a href="https://www.php.net/downloads">Downloads</a></li>
      <li class="active"><a href="https://www.php.net/docs.php">Documentation</a></li>
      <li class=""><a href="https://www.php.net/get-involved" >Get Involved</a></li>
      <li class=""><a href="https://www.php.net/support">Help</a></li>
      <li class="">
        <a href="https://www.php.net/releases/8.3/index.php">
          <img src="../../images/php8/logo_php8_3.svg" alt="php8.3" height="22" width="60">
        </a>
      </li>
    </ul>
    <form class="navbar-search" id="topsearch" action="https://www.php.net/search.php">
      <input type="hidden" name="show" value="quickref">
      <input type="search" name="pattern" class="search-query" placeholder="Search" accesskey="s">
    </form>
  </div>
  <div id="flash-message"></div>
</nav>
<div class="headsup"><a href='https://www.php.net/conferences/index.php#2024-02-13-1'>Dutch PHP Conference 2024</a></div>
<nav id="trick"><div><dl>
<dt><a href='https://www.php.net/manual/en/getting-started.php'>Getting Started</a></dt>
	<dd><a href='https://www.php.net/manual/en/introduction.php'>Introduction</a></dd>
	<dd><a href='https://www.php.net/manual/en/tutorial.php'>A simple tutorial</a></dd>
<dt><a href='https://www.php.net/manual/en/langref.php'>Language Reference</a></dt>
	<dd><a href='https://www.php.net/manual/en/language.basic-syntax.php'>Basic syntax</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.types.php'>Types</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.variables.php'>Variables</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.constants.php'>Constants</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.expressions.php'>Expressions</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.operators.php'>Operators</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.control-structures.php'>Control Structures</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.functions.php'>Functions</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.oop5.php'>Classes and Objects</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.namespaces.php'>Namespaces</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.enumerations.php'>Enumerations</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.errors.php'>Errors</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.exceptions.php'>Exceptions</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.fibers.php'>Fibers</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.generators.php'>Generators</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.attributes.php'>Attributes</a></dd>
	<dd><a href='https://www.php.net/manual/en/language.references.php'>References Explained</a></dd>
	<dd><a href='https://www.php.net/manual/en/reserved.variables.php'>Predefined Variables</a></dd>
	<dd><a href='https://www.php.net/manual/en/reserved.exceptions.php'>Predefined Exceptions</a></dd>
	<dd><a href='https://www.php.net/manual/en/reserved.interfaces.php'>Predefined Interfaces and Classes</a></dd>
	<dd><a href='https://www.php.net/manual/en/reserved.attributes.php'>Predefined Attributes</a></dd>
	<dd><a href='https://www.php.net/manual/en/context.php'>Context options and parameters</a></dd>
	<dd><a href='https://www.php.net/manual/en/wrappers.php'>Supported Protocols and Wrappers</a></dd>
</dl>
<dl>
<dt><a href='https://www.php.net/manual/en/security.php'>Security</a></dt>
	<dd><a href='https://www.php.net/manual/en/security.intro.php'>Introduction</a></dd>
	<dd><a href='https://www.php.net/manual/en/security.general.php'>General considerations</a></dd>
	<dd><a href='https://www.php.net/manual/en/security.cgi-bin.php'>Installed as CGI binary</a></dd>
	<dd><a href='https://www.php.net/manual/en/security.apache.php'>Installed as an Apache module</a></dd>
	<dd><a href='https://www.php.net/manual/en/security.sessions.php'>Session Security</a></dd>
	<dd><a href='https://www.php.net/manual/en/security.filesystem.php'>Filesystem Security</a></dd>
	<dd><a href='https://www.php.net/manual/en/security.database.php'>Database Security</a></dd>
	<dd><a href='https://www.php.net/manual/en/security.errors.php'>Error Reporting</a></dd>
	<dd><a href='https://www.php.net/manual/en/security.variables.php'>User Submitted Data</a></dd>
	<dd><a href='https://www.php.net/manual/en/security.hiding.php'>Hiding PHP</a></dd>
	<dd><a href='https://www.php.net/manual/en/security.current.php'>Keeping Current</a></dd>
<dt><a href='https://www.php.net/manual/en/features.php'>Features</a></dt>
	<dd><a href='https://www.php.net/manual/en/features.http-auth.php'>HTTP authentication with PHP</a></dd>
	<dd><a href='https://www.php.net/manual/en/features.cookies.php'>Cookies</a></dd>
	<dd><a href='https://www.php.net/manual/en/features.sessions.php'>Sessions</a></dd>
	<dd><a href='https://www.php.net/manual/en/features.xforms.php'>Dealing with XForms</a></dd>
	<dd><a href='https://www.php.net/manual/en/features.file-upload.php'>Handling file uploads</a></dd>
	<dd><a href='https://www.php.net/manual/en/features.remote-files.php'>Using remote files</a></dd>
	<dd><a href='https://www.php.net/manual/en/features.connection-handling.php'>Connection handling</a></dd>
	<dd><a href='https://www.php.net/manual/en/features.persistent-connections.php'>Persistent Database Connections</a></dd>
	<dd><a href='https://www.php.net/manual/en/features.commandline.php'>Command line usage</a></dd>
	<dd><a href='https://www.php.net/manual/en/features.gc.php'>Garbage Collection</a></dd>
	<dd><a href='https://www.php.net/manual/en/features.dtrace.php'>DTrace Dynamic Tracing</a></dd>
</dl>
<dl>
<dt><a href='https://www.php.net/manual/en/funcref.php'>Function Reference</a></dt>
	<dd><a href='https://www.php.net/manual/en/refs.basic.php.php'>Affecting PHP's Behaviour</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.utilspec.audio.php'>Audio Formats Manipulation</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.remote.auth.php'>Authentication Services</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.utilspec.cmdline.php'>Command Line Specific Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.compression.php'>Compression and Archive Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.crypto.php'>Cryptography Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.database.php'>Database Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.calendar.php'>Date and Time Related Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.fileprocess.file.php'>File System Related Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.international.php'>Human Language and Character Encoding Support</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.utilspec.image.php'>Image Processing and Generation</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.remote.mail.php'>Mail Related Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.math.php'>Mathematical Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.utilspec.nontext.php'>Non-Text MIME Output</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.fileprocess.process.php'>Process Control Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.basic.other.php'>Other Basic Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.remote.other.php'>Other Services</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.search.php'>Search Engine Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.utilspec.server.php'>Server Specific Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.basic.session.php'>Session Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.basic.text.php'>Text Processing</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.basic.vartype.php'>Variable and Type Related Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.webservice.php'>Web Services</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.utilspec.windows.php'>Windows Only Extensions</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.xml.php'>XML Manipulation</a></dd>
	<dd><a href='https://www.php.net/manual/en/refs.ui.php'>GUI Extensions</a></dd>
</dl>
<dl>
<dt>Keyboard Shortcuts</dt><dt>?</dt>
<dd>This help</dd>
<dt>j</dt>
<dd>Next menu item</dd>
<dt>k</dt>
<dd>Previous menu item</dd>
<dt>g p</dt>
<dd>Previous man page</dd>
<dt>g n</dt>
<dd>Next man page</dd>
<dt>G</dt>
<dd>Scroll to bottom</dd>
<dt>g g</dt>
<dd>Scroll to top</dd>
<dt>g h</dt>
<dd>Goto homepage</dd>
<dt>g s</dt>
<dd>Goto search<br>(current page)</dd>
<dt>/</dt>
<dd>Focus search box</dd>
</dl></div></nav>
<div id="goto">
    <div class="search">
         <div class="text"></div>
         <div class="results"><ul></ul></div>
   </div>
</div>

  <div id="breadcrumbs" class="clearfix">
    <div id="breadcrumbs-inner">
          <div class="next">
        <a href="security.filesystem.nullbytes.php.html">
          Проблемы безопасности, связанные с нулевым байтом &raquo;
        </a>
      </div>
              <div class="prev">
        <a href="security.sessions.php.html">
          &laquo; Безопасность сессий        </a>
      </div>
          <ul>
            <li><a href='index.php.html'>Руководство по PHP</a></li>      <li><a href='security.php.html'>Безопасность</a></li>      </ul>
    </div>
  </div>




<div id="layout" class="clearfix">
  <section id="layout-content">
  <div class="page-tools">
    <div class="change-language">
      <form action="https://www.php.net/manual/change.php" method="get" id="changelang" name="changelang">
        <fieldset>
          <label for="changelang-langs">Change language:</label>
          <select onchange="document.changelang.submit()" name="page" id="changelang-langs">
            <option value='en/security.filesystem.php'>English</option>
            <option value='de/security.filesystem.php'>German</option>
            <option value='es/security.filesystem.php'>Spanish</option>
            <option value='fr/security.filesystem.php'>French</option>
            <option value='it/security.filesystem.php'>Italian</option>
            <option value='ja/security.filesystem.php'>Japanese</option>
            <option value='pt_BR/security.filesystem.php'>Brazilian Portuguese</option>
            <option value='ru/security.filesystem.php' selected="selected">Russian</option>
            <option value='tr/security.filesystem.php'>Turkish</option>
            <option value='zh/security.filesystem.php'>Chinese (Simplified)</option>
            <option value='help-translate.php'>Other</option>
          </select>
        </fieldset>
      </form>
    </div>
    <div class="edit-bug">
      <a href="https://github.com/php/doc-ru/blob/master/security/filesystem.xml">Submit a Pull Request</a>
      <a href="https://github.com/php/doc-ru/issues/new?body=From%20manual%20page:%20https:%2F%2Fphp.net%2Fsecurity.filesystem%0A%0A---">Report a Bug</a>
    </div>
  </div><div id="security.filesystem" class="chapter">
   <h1>Безопасность файловой системы</h1>
<h2>Содержание</h2><ul class="chunklist chunklist_chapter"><li><a href="security.filesystem.nullbytes.php.html">Проблемы безопасности, связанные с нулевым байтом</a></li></ul>

   <p class="simpara">
    <abbr title="PHP: Hypertext Preprocessor">PHP</abbr> является одним из важных моментов в вопросе безопасности сервера,
    поскольку PHP-скрипты могут манипулировать файлами и каталогами
    на диске. В связи с этим существуют конфигурационные настройки,
    указывающие, какие файлы могут быть доступны и какие операции с ними можно
    выполнять. Необходимо проявлять осторожность, поскольку любой из файлов,
    с полными правами чтения (&quot;world readable&quot;) может быть прочитан
    каждым, кто имеет доступ к файловой системе.
   </p>
   <p class="simpara">
    Поскольку в <abbr title="PHP: Hypertext Preprocessor">PHP</abbr> изначально предполагался полноправный пользовательский
    доступ к файловой системе, можно написать <abbr title="PHP: Hypertext Preprocessor">PHP</abbr>-скрипт,
    который позволит читать системные файлы, такие как /etc/passwd,
    управлять сетевыми соединениями, отправлять задания принтеру, и
    так далее. Как следствие, вы всегда должны быть уверены в том, что
    файлы, которые вы читаете или модифицируете, являются именно теми,
    которые вы подразумевали.
   </p>
   <p class="simpara">
    Рассмотрим следующий пример, в котором пользователь создал скрипт, удаляющий
    файл из его домашней директории. Предполагается ситуация, когда веб-интерфейс,
    написанный на <abbr title="PHP: Hypertext Preprocessor">PHP</abbr>, регулярно используется для
    работы с файлами, и настройки безопасности позволяют удалять
    файлы в домашнем каталоге.
   </p>
   <p class="para">
    <div class="example" id="example-1294">
     <p><strong>Пример #1 Недостаточная проверка внешних данных ведёт к...</strong></p>
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">// Удаление файла из домашней директории пользователя<br /></span><span style="color: #0000BB">$username </span><span style="color: #007700">= </span><span style="color: #0000BB">$_POST</span><span style="color: #007700">[</span><span style="color: #DD0000">'user_submitted_name'</span><span style="color: #007700">];<br /></span><span style="color: #0000BB">$userfile </span><span style="color: #007700">= </span><span style="color: #0000BB">$_POST</span><span style="color: #007700">[</span><span style="color: #DD0000">'user_submitted_filename'</span><span style="color: #007700">];<br /></span><span style="color: #0000BB">$homedir  </span><span style="color: #007700">= </span><span style="color: #DD0000">"/home/</span><span style="color: #0000BB">$username</span><span style="color: #DD0000">"</span><span style="color: #007700">;<br /><br /></span><span style="color: #0000BB">unlink</span><span style="color: #007700">(</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$homedir</span><span style="color: #DD0000">/</span><span style="color: #0000BB">$userfile</span><span style="color: #DD0000">"</span><span style="color: #007700">);<br /><br />echo </span><span style="color: #DD0000">"Файл был удалён!"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
     </div>

    </div>
   Поскольку переменные вводятся в пользовательской форме, существует
   возможность удалить файлы, принадлежащие кому-либо другому, введя
   соответствующие значения. В этом случае может понадобиться авторизация.
   Посмотрим, что произойдёт, если будут отправлены значения
   &quot;../etc/&quot; и &quot;passwd&quot;. Скрипт выполнит следующие действия:
    <div class="example" id="example-1297">
     <p><strong>Пример #2 ... атаке на файловую систему</strong></p>
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">// Удаление любого файла, доступного из PHP-скрипта.<br />// В случае, если PHP работает с правами пользователя root:<br /></span><span style="color: #0000BB">$username </span><span style="color: #007700">= </span><span style="color: #0000BB">$_POST</span><span style="color: #007700">[</span><span style="color: #DD0000">'user_submitted_name'</span><span style="color: #007700">]; </span><span style="color: #FF8000">// "../etc"<br /></span><span style="color: #0000BB">$userfile </span><span style="color: #007700">= </span><span style="color: #0000BB">$_POST</span><span style="color: #007700">[</span><span style="color: #DD0000">'user_submitted_filename'</span><span style="color: #007700">]; </span><span style="color: #FF8000">// "passwd"<br /></span><span style="color: #0000BB">$homedir  </span><span style="color: #007700">= </span><span style="color: #DD0000">"/home/</span><span style="color: #0000BB">$username</span><span style="color: #DD0000">"</span><span style="color: #007700">; </span><span style="color: #FF8000">// "/home/../etc"<br /><br /></span><span style="color: #0000BB">unlink</span><span style="color: #007700">(</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$homedir</span><span style="color: #DD0000">/</span><span style="color: #0000BB">$userfile</span><span style="color: #DD0000">"</span><span style="color: #007700">); </span><span style="color: #FF8000">// "/home/../etc/passwd"<br /><br /></span><span style="color: #007700">echo </span><span style="color: #DD0000">"Файл был удалён!"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
     </div>

    </div>
    Существуют две важные меры, которые можно предпринять для предотвращения
    описанной проблемы.
    <ul class="itemizedlist">
     <li class="listitem">
      <span class="simpara">
       Ограничить доступ пользователя, с правами которого работает веб-сервер
       с <abbr title="PHP: Hypertext Preprocessor">PHP</abbr>.
      </span>
     </li>
     <li class="listitem">
      <span class="simpara">
      Проверять все данные, вводимые пользователем.
      </span>
     </li>
    </ul>
    Вот улучшенный вариант кода:
    <div class="example" id="example-1300">
     <p><strong>Пример #3 Более безопасная проверка имени файла</strong></p>
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">// Удаление любого файла, к которому имеет доступ пользователь,<br />// под которым запущен PHP.<br /></span><span style="color: #0000BB">$username </span><span style="color: #007700">= </span><span style="color: #0000BB">$_SERVER</span><span style="color: #007700">[</span><span style="color: #DD0000">'REMOTE_USER'</span><span style="color: #007700">]; </span><span style="color: #FF8000">// использование авторизации<br /></span><span style="color: #0000BB">$userfile </span><span style="color: #007700">= </span><span style="color: #0000BB">basename</span><span style="color: #007700">(</span><span style="color: #0000BB">$_POST</span><span style="color: #007700">[</span><span style="color: #DD0000">'user_submitted_filename'</span><span style="color: #007700">]);<br /></span><span style="color: #0000BB">$homedir  </span><span style="color: #007700">= </span><span style="color: #DD0000">"/home/</span><span style="color: #0000BB">$username</span><span style="color: #DD0000">"</span><span style="color: #007700">;<br /><br /></span><span style="color: #0000BB">$filepath </span><span style="color: #007700">= </span><span style="color: #DD0000">"</span><span style="color: #0000BB">$homedir</span><span style="color: #DD0000">/</span><span style="color: #0000BB">$userfile</span><span style="color: #DD0000">"</span><span style="color: #007700">;<br /><br />if (</span><span style="color: #0000BB">file_exists</span><span style="color: #007700">(</span><span style="color: #0000BB">$filepath</span><span style="color: #007700">) &amp;&amp; </span><span style="color: #0000BB">unlink</span><span style="color: #007700">(</span><span style="color: #0000BB">$filepath</span><span style="color: #007700">)) {<br />    </span><span style="color: #0000BB">$logstring </span><span style="color: #007700">= </span><span style="color: #DD0000">"</span><span style="color: #0000BB">$filepath</span><span style="color: #DD0000"> удалён\n"</span><span style="color: #007700">;<br />} else {<br />    </span><span style="color: #0000BB">$logstring </span><span style="color: #007700">= </span><span style="color: #DD0000">"Не удалось удалить </span><span style="color: #0000BB">$filepath</span><span style="color: #DD0000">\n"</span><span style="color: #007700">;<br />}<br /></span><span style="color: #0000BB">$fp </span><span style="color: #007700">= </span><span style="color: #0000BB">fopen</span><span style="color: #007700">(</span><span style="color: #DD0000">"/home/logging/filedelete.log"</span><span style="color: #007700">, </span><span style="color: #DD0000">"a"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">, </span><span style="color: #0000BB">$logstring</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);<br /><br />echo </span><span style="color: #0000BB">htmlentities</span><span style="color: #007700">(</span><span style="color: #0000BB">$logstring</span><span style="color: #007700">, </span><span style="color: #0000BB">ENT_QUOTES</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
     </div>

    </div>
    Однако и такая проверка не учитывает все возможные ситуации. Если
    система авторизации позволяет пользователям выбирать произвольные логины,
    взломщик может создать учётную запись вида &quot;../etc/&quot; и система опять
    окажется уязвимой. Исходя из этого, вам может понадобиться более строгая проверка:
    <div class="example" id="example-1303">
     <p><strong>Пример #4 Более строгая проверка имени файла</strong></p>
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br />$username     </span><span style="color: #007700">= </span><span style="color: #0000BB">$_SERVER</span><span style="color: #007700">[</span><span style="color: #DD0000">'REMOTE_USER'</span><span style="color: #007700">]; </span><span style="color: #FF8000">// использование авторизации<br /></span><span style="color: #0000BB">$userfile     </span><span style="color: #007700">= </span><span style="color: #0000BB">$_POST</span><span style="color: #007700">[</span><span style="color: #DD0000">'user_submitted_filename'</span><span style="color: #007700">];<br /></span><span style="color: #0000BB">$homedir      </span><span style="color: #007700">= </span><span style="color: #DD0000">"/home/</span><span style="color: #0000BB">$username</span><span style="color: #DD0000">"</span><span style="color: #007700">;<br /><br /></span><span style="color: #0000BB">$filepath     </span><span style="color: #007700">= </span><span style="color: #DD0000">"</span><span style="color: #0000BB">$homedir</span><span style="color: #DD0000">/</span><span style="color: #0000BB">$userfile</span><span style="color: #DD0000">"</span><span style="color: #007700">;<br /><br />if (!</span><span style="color: #0000BB">ctype_alnum</span><span style="color: #007700">(</span><span style="color: #0000BB">$username</span><span style="color: #007700">) || !</span><span style="color: #0000BB">preg_match</span><span style="color: #007700">(</span><span style="color: #DD0000">'/^(?:[a-z0-9_-]|\.(?!\.))+$/iD'</span><span style="color: #007700">, </span><span style="color: #0000BB">$userfile</span><span style="color: #007700">)) {<br />    die(</span><span style="color: #DD0000">"Неправильное имя пользователя или файл"</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #FF8000">//etc...<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
     </div>

    </div>
   </p>
   <p class="para">
    В зависимости от используемой вами операционной системы необходимо
    предусматривать возможность атаки на разнообразные файлы, включая
    системные файлы устройств (/dev/ или COM1), конфигурационные файлы
    (например /etc/ или файлы с расширением .ini), хорошо известные
    области хранения данных (/home/, My Documents), и так далее.
    Исходя из этого, как правило, легче реализовать такую политику
    безопасности, в которой запрещено все, исключая то, что явно
    разрешено.
   </p>
   

  </div>
<section id="usernotes">
 <div class="head">
  <span class="action"><a href="https://www.php.net/manual/add-note.php?sect=security.filesystem&amp;redirect=https://www.php.net/manual/ru/security.filesystem.php">＋<small>add a note</small></a></span>
  <h3 class="title">User Contributed Notes <span class="count">7 notes</span></h3>
 </div><div id="allnotes">
  <div class="note" id="58832">  <div class="votes">
    <div id="Vu58832">
    <a href="https://www.php.net/manual/vote-note.php?id=58832&amp;page=security.filesystem&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd58832">
    <a href="https://www.php.net/manual/vote-note.php?id=58832&amp;page=security.filesystem&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V58832" title="77% like this...">
    95
    </div>
  </div>
  <a href="security.filesystem.php.html#58832" class="name">
  <strong class="user"><em>anonymous</em></strong></a><a class="genanchor" href="security.filesystem.php.html#58832"> &para;</a><div class="date" title="2005-11-17 02:58"><strong>18 years ago</strong></div>
  <div class="text" id="Hcom58832">
<div class="phpcode"><code><span class="html">(A) Better not to create files or folders with user-supplied names. If you do not validate enough, you can have trouble. Instead create files and folders with randomly generated names like fg3754jk3h and store the username and this file or folder name in a table named, say, user_objects. This will ensure that whatever the user may type, the command going to the shell will contain values from a specific set only and no mischief can be done.<br /><br />(B) The same applies to commands executed based on an operation that the user chooses. Better not to allow any part of the user's input to go to the command that you will execute. Instead, keep a fixed set of commands and based on what the user has input, and run those only. <br /><br />For example,<br />(A) Keep a table named, say, user_objects with values like:<br />username|chosen_name   |actual_name|file_or_dir<br />--------|--------------|-----------|-----------<br />jdoe    |trekphotos    |m5fg767h67 |D<br />jdoe    |notes.txt     |nm4b6jh756 |F<br />tim1997 |_imp_ folder  |45jkh64j56 |D<br /><br />and always use the actual_name in the filesystem operations rather than the user supplied names.<br /><br />(B)<br /><span class="default">&lt;?php<br />$op </span><span class="keyword">= </span><span class="default">$_POST</span><span class="keyword">[</span><span class="string">'op'</span><span class="keyword">];</span><span class="comment">//after a lot of validations <br /></span><span class="default">$dir </span><span class="keyword">= </span><span class="default">$_POST</span><span class="keyword">[</span><span class="string">'dirname'</span><span class="keyword">];</span><span class="comment">//after a lot of validations or maybe you can use technique (A)<br /></span><span class="keyword">switch(</span><span class="default">$op</span><span class="keyword">){<br />    case </span><span class="string">"cd"</span><span class="keyword">:<br />        </span><span class="default">chdir</span><span class="keyword">(</span><span class="default">$dir</span><span class="keyword">);<br />        break;<br />    case </span><span class="string">"rd"</span><span class="keyword">:<br />        </span><span class="default">rmdir</span><span class="keyword">(</span><span class="default">$dir</span><span class="keyword">);<br />        break;<br />    .....<br />    default:<br />        </span><span class="default">mail</span><span class="keyword">(</span><span class="string">"webmaster@example.com"</span><span class="keyword">, </span><span class="string">"Mischief"</span><span class="keyword">, </span><span class="default">$_SERVER</span><span class="keyword">[</span><span class="string">'REMOTE_ADDR'</span><span class="keyword">].</span><span class="string">" is probably attempting an attack."</span><span class="keyword">);<br />}</span></span></code></div>
  </div>
 </div>
  <div class="note" id="57642">  <div class="votes">
    <div id="Vu57642">
    <a href="https://www.php.net/manual/vote-note.php?id=57642&amp;page=security.filesystem&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd57642">
    <a href="https://www.php.net/manual/vote-note.php?id=57642&amp;page=security.filesystem&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V57642" title="62% like this...">
    18
    </div>
  </div>
  <a href="security.filesystem.php.html#57642" class="name">
  <strong class="user"><em>fmrose at ncsu dot edu</em></strong></a><a class="genanchor" href="security.filesystem.php.html#57642"> &para;</a><div class="date" title="2005-10-09 04:31"><strong>18 years ago</strong></div>
  <div class="text" id="Hcom57642">
<div class="phpcode"><code><span class="html">All of the fixes here assume that it is necessary to allow the user to enter system sensitive information to begin with. The proper way to handle this would be to provide something like a numbered list of files to perform an unlink action on and then the chooses the matching number. There is no way for the user to specify a clever attack circumventing whatever pattern matching filename exclusion syntax that you may have.<br /><br />Anytime you have a security issue, the proper behaviour is to deny all then allow specific instances, not allow all and restrict. For the simple reason that you may not think of every possible restriction.</span></code></div>
  </div>
 </div>
  <div class="note" id="14915">  <div class="votes">
    <div id="Vu14915">
    <a href="https://www.php.net/manual/vote-note.php?id=14915&amp;page=security.filesystem&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd14915">
    <a href="https://www.php.net/manual/vote-note.php?id=14915&amp;page=security.filesystem&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V14915" title="62% like this...">
    16
    </div>
  </div>
  <a href="security.filesystem.php.html#14915" class="name">
  <strong class="user"><em>devik at cdi dot cz</em></strong></a><a class="genanchor" href="security.filesystem.php.html#14915"> &para;</a><div class="date" title="2001-08-21 07:52"><strong>22 years ago</strong></div>
  <div class="text" id="Hcom14915">
<div class="phpcode"><code><span class="html">Well, the fact that all users run under the same UID is a big problem. Userspace  security hacks (ala safe_mode) should not be substitution for proper kernel level security checks/accounting.<br />Good news: Apache 2 allows you to assign UIDs for different vhosts.<br />devik</span></code></div>
  </div>
 </div>
  <div class="note" id="89480">  <div class="votes">
    <div id="Vu89480">
    <a href="https://www.php.net/manual/vote-note.php?id=89480&amp;page=security.filesystem&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd89480">
    <a href="https://www.php.net/manual/vote-note.php?id=89480&amp;page=security.filesystem&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V89480" title="57% like this...">
    10
    </div>
  </div>
  <a href="security.filesystem.php.html#89480" class="name">
  <strong class="user"><em>Latchezar Tzvetkoff</em></strong></a><a class="genanchor" href="security.filesystem.php.html#89480"> &para;</a><div class="date" title="2009-03-10 03:06"><strong>14 years ago</strong></div>
  <div class="text" id="Hcom89480">
<div class="phpcode"><code><span class="html">A basic filename/directory/symlink checking may be done (and I personally do) via realpath() ...<br /><br /><span class="default">&lt;?php<br /><br /></span><span class="keyword">if (isset(</span><span class="default">$_GET</span><span class="keyword">[</span><span class="string">'file'</span><span class="keyword">])) {<br />    </span><span class="default">$base </span><span class="keyword">= </span><span class="string">'/home/polizei/public_html/'</span><span class="keyword">;  </span><span class="comment">// it seems this one is good to be realpath too.. meaning not a symlinked path..<br />    </span><span class="keyword">if (</span><span class="default">strpos</span><span class="keyword">(</span><span class="default">$file </span><span class="keyword">= </span><span class="default">realpath</span><span class="keyword">(</span><span class="default">$base</span><span class="keyword">.</span><span class="default">$_GET</span><span class="keyword">[</span><span class="string">'file'</span><span class="keyword">]), </span><span class="default">$base</span><span class="keyword">) === </span><span class="default">0 </span><span class="keyword">&amp;&amp; </span><span class="default">is_file</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">)) {<br />        </span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">);<br />    } else {<br />        die(</span><span class="string">'blah!'</span><span class="keyword">);<br />    }<br />}<br /></span><span class="default">?&gt;</span></span></code></div>
  </div>
 </div>
  <div class="note" id="17978">  <div class="votes">
    <div id="Vu17978">
    <a href="https://www.php.net/manual/vote-note.php?id=17978&amp;page=security.filesystem&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd17978">
    <a href="https://www.php.net/manual/vote-note.php?id=17978&amp;page=security.filesystem&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V17978" title="56% like this...">
    7
    </div>
  </div>
  <a href="security.filesystem.php.html#17978" class="name">
  <strong class="user"><em>cronos586(AT)caramail(DOT)com</em></strong></a><a class="genanchor" href="security.filesystem.php.html#17978"> &para;</a><div class="date" title="2002-01-05 03:48"><strong>22 years ago</strong></div>
  <div class="text" id="Hcom17978">
<div class="phpcode"><code><span class="html">when using Apache you might consider a apache_lookup_uri on the path, to discover the real path, regardless of any directory trickery.<br />then, look at the prefix, and compare with a list of allowed prefixes.<br />for example, my source.php for my website includes:<br />if(isset($doc)) {<br />    $apacheres = apache_lookup_uri($doc);<br />    $really = realpath($apacheres-&gt;filename);<br />    if(substr($really, 0, strlen($DOCUMENT_ROOT)) == $DOCUMENT_ROOT) {<br />        if(is_file($really)) {<br />            show_source($really);<br />        }<br />    }<br />}<br />hope this helps<br />regards,<br />KAT44</span></code></div>
  </div>
 </div>
  <div class="note" id="54088">  <div class="votes">
    <div id="Vu54088">
    <a href="https://www.php.net/manual/vote-note.php?id=54088&amp;page=security.filesystem&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd54088">
    <a href="https://www.php.net/manual/vote-note.php?id=54088&amp;page=security.filesystem&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V54088" title="44% like this...">
    -9
    </div>
  </div>
  <a href="security.filesystem.php.html#54088" class="name">
  <strong class="user"><em>1 at 234 dot cx</em></strong></a><a class="genanchor" href="security.filesystem.php.html#54088"> &para;</a><div class="date" title="2005-06-23 05:24"><strong>18 years ago</strong></div>
  <div class="text" id="Hcom54088">
<div class="phpcode"><code><span class="html">I don't think the filename validation solution from Jones at partykel is complete.  It certainly helps, but it doesn't address the case where the user is able to create a symlink pointing from his home directory to the root.  He might then ask to unlink "foo/etc/passwd" which would be in his home directory, except that foo is a symlink pointing to /.<br /><br />Personally I wouldn't feel confident that any solution to this problem would keep my system secure.  Running PHP as root (or some equivalent which can unlink files in all users' home directories) is asking for trouble.<br /><br />If you have a multi-user system and you are afraid that users may install scripts like this, try security-enhanced Linux.  It won't give total protection, but it at least makes sure that an insecure user script can only affect files which the web server is meant to have access to.  Whatever script someone installs, outsiders are not going to be able to read your password file---or remove it.</span></code></div>
  </div>
 </div>
  <div class="note" id="9563">  <div class="votes">
    <div id="Vu9563">
    <a href="https://www.php.net/manual/vote-note.php?id=9563&amp;page=security.filesystem&amp;vote=up" title="Vote up!" class="usernotes-voteu">up</a>
    </div>
    <div id="Vd9563">
    <a href="https://www.php.net/manual/vote-note.php?id=9563&amp;page=security.filesystem&amp;vote=down" title="Vote down!" class="usernotes-voted">down</a>
    </div>
    <div class="tally" id="V9563" title="40% like this...">
    -15
    </div>
  </div>
  <a href="security.filesystem.php.html#9563" class="name">
  <strong class="user"><em>eLuddite at not dot a dot real dot addressnsky dot ru</em></strong></a><a class="genanchor" href="security.filesystem.php.html#9563"> &para;</a><div class="date" title="2000-11-11 09:44"><strong>23 years ago</strong></div>
  <div class="text" id="Hcom9563">
<div class="phpcode"><code><span class="html">I think the lesson is clear:<br /><br />(1) Forbit path separators in usernames.<br />(2) map username to a physical home directory - /home/username is fine<br />(3) read the home directory<br />(4) present only results of (3) as an option for deletion.<br /><br />I have discovered a marvelous method of doing the above in php but this submission box is too small to contain it.<br /><br />:-)</span></code></div>
  </div>
 </div></div>
<div class="foot"><a href="https://www.php.net/manual/add-note.php?sect=security.filesystem&amp;redirect=https://www.php.net/manual/ru/security.filesystem.php">＋<small>add a note</small></a></div>
</section>    </section><!-- layout-content -->
        <aside class='layout-menu'>

        <ul class='parent-menu-list'>
                                    <li>
                <a href="security.php.html">Безопасность</a>

                                    <ul class='child-menu-list'>

                                                <li class="">
                            <a href="security.intro.php.html" title="Вступление">Вступление</a>
                        </li>
                                                <li class="">
                            <a href="security.general.php.html" title="Общие рассуждения">Общие рассуждения</a>
                        </li>
                                                <li class="">
                            <a href="security.cgi-bin.php.html" title="Если PHP установлен как CGI">Если PHP установлен как CGI</a>
                        </li>
                                                <li class="">
                            <a href="security.apache.php.html" title="Если PHP установлен как модуль Apache">Если PHP установлен как модуль Apache</a>
                        </li>
                                                <li class="">
                            <a href="security.sessions.php.html" title="Безопасность сессий">Безопасность сессий</a>
                        </li>
                                                <li class="current">
                            <a href="security.filesystem.php.html" title="Безопасность файловой системы">Безопасность файловой системы</a>
                        </li>
                                                <li class="">
                            <a href="security.database.php.html" title="Безопасность баз данных">Безопасность баз данных</a>
                        </li>
                                                <li class="">
                            <a href="security.errors.php.html" title="Сообщения об ошибках">Сообщения об ошибках</a>
                        </li>
                                                <li class="">
                            <a href="security.variables.php.html" title="Данные, введённые пользователем">Данные, введённые пользователем</a>
                        </li>
                                                <li class="">
                            <a href="security.hiding.php.html" title="Сокрытие PHP">Сокрытие PHP</a>
                        </li>
                                                <li class="">
                            <a href="security.current.php.html" title="Необходимость обновлений">Необходимость обновлений</a>
                        </li>
                        
                    </ul>
                
            </li>
                        
                    </ul>
    </aside>


  </div><!-- layout -->

  <footer>
    <div class="container footer-content">
      <div class="row-fluid">
      <ul class="footmenu">
        <li><a href="https://www.php.net/copyright.php">Copyright &copy; 2001-2024 The PHP Group</a></li>
        <li><a href="https://www.php.net/my.php">My PHP.net</a></li>
        <li><a href="https://www.php.net/contact.php">Contact</a></li>
        <li><a href="https://www.php.net/sites.php">Other PHP.net sites</a></li>
        <li><a href="https://www.php.net/privacy.php">Privacy policy</a></li>
      </ul>
      </div>
    </div>
  </footer>

    
 <!-- External and third party libraries. -->
 <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="../../cached.php%3Ft=1657730402&amp;f=%252Fjs%252Fext%252Fhogan-3.0.2.min.js"></script>
<script src="../../cached.php%3Ft=1421837618&amp;f=%252Fjs%252Fext%252Ftypeahead.min.js"></script>
<script src="../../cached.php%3Ft=1657876202&amp;f=%252Fjs%252Fext%252Fmousetrap.min.js"></script>
<script src="../../cached.php%3Ft=1657730402&amp;f=%252Fjs%252Fext%252Fjquery.scrollTo.min.js"></script>
<script src="../../cached.php%3Ft=1701958202&amp;f=%252Fjs%252Fsearch.js"></script>
<script src="../../cached.php%3Ft=1701958202&amp;f=%252Fjs%252Fcommon.js"></script>

<a id="toTop" href="javascript:;"><span id="toTopHover"></span><img width="40" height="40" alt="To Top" src="../../images/to-top@2x.png"></a>

</body>
</html>
